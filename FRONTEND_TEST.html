<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modal Fix Frontend Test</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            padding: 20px;
            background: #f8f9fa;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .console-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .test-button {
            margin: 5px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-pass { background: #28a745; }
        .status-fail { background: #dc3545; }
        .status-warn { background: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">🛡️ Modal Fix Frontend Test</h1>
        
        <div class="test-section">
            <h3>🎯 Test Results Dashboard</h3>
            <div id="testResults">
                <div id="status-bootstrap"><span class="status-indicator status-warn"></span>Bootstrap Loading: <span class="text-warning">Checking...</span></div>
                <div id="status-modal"><span class="status-indicator status-warn"></span>Modal Element: <span class="text-warning">Checking...</span></div>
                <div id="status-patches"><span class="status-indicator status-warn"></span>Fix Patches: <span class="text-warning">Checking...</span></div>
                <div id="status-instance"><span class="status-indicator status-warn"></span>Instance Creation: <span class="text-warning">Checking...</span></div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>🧪 Interactive Tests</h3>
            <button class="btn btn-primary test-button" data-bs-toggle="modal" data-bs-target="#restoreModal">
                Open Restore Modal (Normal)
            </button>
            <button class="btn btn-warning test-button" onclick="testMissingModal()">
                Test Missing Modal
            </button>
            <button class="btn btn-danger test-button" onclick="testBrokenBootstrap()">
                Test Broken Bootstrap
            </button>
            <button class="btn btn-success test-button" onclick="runAllTests()">
                Run All Tests
            </button>
            <button class="btn btn-secondary test-button" onclick="clearConsole()">
                Clear Console
            </button>
        </div>
        
        <div class="test-section">
            <h3>📟 Console Output</h3>
            <div id="consoleOutput" class="console-output">
                Waiting for Bootstrap to load...
            </div>
        </div>
        
        <div class="test-section">
            <h3>📊 Expected Fix Messages</h3>
            <div class="alert alert-info">
                <strong>Look for these messages in console:</strong>
                <ul class="mb-0">
                    <li><code>🏗️ INTERCEPTED Modal creation...</code></li>
                    <li><code>🔍 INTERCEPTED getOrCreateInstance...</code></li>
                    <li><code>✅ Bootstrap Modal ULTRA-COMPREHENSIVE fix applied</code></li>
                    <li><code>🔧 EventHandler.trigger called, validating...</code></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Test Modal (Same as real restore modal) -->
    <div class="modal fade" id="restoreModal" tabindex="-1" aria-labelledby="restoreModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="border-radius: 16px; overflow: hidden;">
                <div class="modal-header border-0" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); padding: 2rem;">
                    <div class="d-flex align-items-center w-100">
                        <div class="p-3 rounded-circle me-3" style="background: rgba(255, 255, 255, 0.2);">
                            <i class="fas fa-upload text-white fa-lg"></i>
                        </div>
                        <div>
                            <h4 class="modal-title text-white fw-bold mb-1" id="restoreModalLabel">
                                🧪 Test Restore Modal
                            </h4>
                            <p class="mb-0" style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem;">
                                Testing modal functionality with our fixes
                            </p>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 2rem;">
                    <div class="alert alert-success">
                        <strong>✅ Success!</strong> Modal opened without JavaScript errors. Our fix is working!
                    </div>
                    <p>This modal demonstrates that our comprehensive Bootstrap modal fix is functioning correctly.</p>
                </div>
                <div class="modal-footer border-0" style="padding: 1rem 2rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success">Test Successful</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    
    <!-- OUR MODAL FIX - Copied from base.html -->
    <script>
      // Ultra-comprehensive Bootstrap Modal fix system
      
      // Step 1: Patch the Bootstrap event system to handle null triggers
      if (typeof window.EventTarget !== 'undefined' && window.EventTarget.prototype.dispatchEvent) {
        const originalDispatchEvent = window.EventTarget.prototype.dispatchEvent;
        window.EventTarget.prototype.dispatchEvent = function(event) {
          try {
            if (!event) {
              console.warn('🔧 Fixing null event in dispatchEvent');
              logToConsole('🔧 Fixing null event in dispatchEvent');
              return true;
            }
            
            if (typeof event.defaultPrevented === 'undefined') {
              console.warn('🔧 Fixing missing defaultPrevented property');
              logToConsole('🔧 Fixing missing defaultPrevented property');
              event.defaultPrevented = false;
            }
            
            return originalDispatchEvent.call(this, event);
          } catch (error) {
            console.error('❌ Error in dispatchEvent, recovering:', error);
            logToConsole('❌ Error in dispatchEvent, recovering: ' + error.message);
            return true;
          }
        };
      }
      
      // Step 2: Patch Bootstrap's trigger method if it exists
      if (typeof bootstrap !== 'undefined' && bootstrap.EventHandler && bootstrap.EventHandler.trigger) {
        const originalTrigger = bootstrap.EventHandler.trigger;
        bootstrap.EventHandler.trigger = function(element, event, eventProperties) {
          console.log('🔧 EventHandler.trigger called, validating...');
          logToConsole('🔧 EventHandler.trigger called, validating...');
          
          try {
            if (!element) {
              console.warn('🔧 Fixing null element in trigger');
              logToConsole('🔧 Fixing null element in trigger');
              return null;
            }
            
            const result = originalTrigger.call(this, element, event, eventProperties);
            
            if (result && typeof result.defaultPrevented === 'undefined') {
              console.warn('🔧 Fixing missing defaultPrevented in trigger result');
              logToConsole('🔧 Fixing missing defaultPrevented in trigger result');
              result.defaultPrevented = false;
            }
            
            return result;
          } catch (error) {
            console.error('❌ Error in EventHandler.trigger, returning safe default:', error);
            logToConsole('❌ Error in EventHandler.trigger: ' + error.message);
            return { defaultPrevented: false, type: event };
          }
        };
      }
      
      // Step 3: Core Bootstrap Modal fixes
      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        // Patch show method
        const originalShow = bootstrap.Modal.prototype.show;
        if (originalShow) {
          bootstrap.Modal.prototype.show = function() {
            console.log('🎭 Modal show() called, pre-validating...');
            logToConsole('🎭 Modal show() called, pre-validating...');
            
            if (!this._element) {
              console.error('❌ Cannot show modal: _element is undefined');
              logToConsole('❌ Cannot show modal: _element is undefined');
              return;
            }
            
            if (!this._config) {
              console.warn('🔧 Fixing missing _config in show()');
              logToConsole('🔧 Fixing missing _config in show()');
              this._config = { backdrop: true, keyboard: true, focus: true };
            }
            
            console.log('✅ Modal pre-validation passed, calling original show');
            logToConsole('✅ Modal pre-validation passed, calling original show');
            
            try {
              return originalShow.call(this);
            } catch (error) {
              console.error('❌ Error in modal show():', error);
              logToConsole('❌ Error in modal show(): ' + error.message);
              throw error;
            }
          };
        }
        
        // Ultra-aggressive constructor override
        const OriginalModal = bootstrap.Modal;
        bootstrap.Modal = function(element, config) {
          console.log('🏗️ INTERCEPTED Modal creation...');
          logToConsole('🏗️ INTERCEPTED Modal creation...');
          
          let targetElement = null;
          
          if (!element) {
            console.error('❌ Modal element is null/undefined - BLOCKING CREATION');
            logToConsole('❌ Modal element is null/undefined - BLOCKING CREATION');
            targetElement = document.createElement('div');
            targetElement.className = 'modal fade';
            targetElement.id = 'emergency-modal-' + Date.now();
            targetElement.innerHTML = '<div class="modal-dialog"><div class="modal-content"><div class="modal-body">Emergency modal placeholder</div></div></div>';
            document.body.appendChild(targetElement);
            logToConsole('🚨 Created emergency placeholder modal: ' + targetElement.id);
          } else if (typeof element === 'string') {
            targetElement = document.querySelector(element);
            if (!targetElement) {
              console.error('❌ Element not found with selector:', element);
              logToConsole('❌ Element not found with selector: ' + element);
              const modalId = element.replace('#', '');
              targetElement = document.createElement('div');
              targetElement.className = 'modal fade';
              targetElement.id = modalId;
              targetElement.innerHTML = '<div class="modal-dialog"><div class="modal-content"><div class="modal-body">Modal not found, created emergency replacement</div></div></div>';
              document.body.appendChild(targetElement);
              logToConsole('🚨 Created emergency modal for missing selector: ' + modalId);
            } else {
              logToConsole('✅ Found element by selector: ' + targetElement.id);
            }
          } else if (element.nodeType === 1) {
            targetElement = element;
            logToConsole('✅ Using provided DOM element: ' + (targetElement.id || 'no-id'));
          }
          
          config = config || {};
          if (typeof config.backdrop === 'undefined') config.backdrop = true;
          if (typeof config.keyboard === 'undefined') config.keyboard = true;
          if (typeof config.focus === 'undefined') config.focus = true;
          
          let instance;
          try {
            logToConsole('🔨 Calling original constructor with validated element...');
            instance = new OriginalModal(targetElement, config);
            logToConsole('✅ Original constructor succeeded');
          } catch (error) {
            console.error('❌ Original constructor failed:', error);
            logToConsole('❌ Original constructor failed: ' + error.message);
            
            instance = {
              _element: targetElement,
              _config: config,
              show: function() {
                logToConsole('📱 Mock modal show() called');
                targetElement.style.display = 'block';
                targetElement.classList.add('show');
              },
              hide: function() {
                logToConsole('📱 Mock modal hide() called');
                targetElement.style.display = 'none';
                targetElement.classList.remove('show');
              },
              toggle: function() {
                logToConsole('📱 Mock modal toggle() called');
                if (targetElement.classList.contains('show')) {
                  this.hide();
                } else {
                  this.show();
                }
              },
              dispose: function() {
                logToConsole('📱 Mock modal dispose() called');
              },
              _isShown: false
            };
            logToConsole('✅ Created functional mock modal instance');
          }
          
          if (!instance._config) {
            instance._config = config;
          }
          if (!instance._element) {
            instance._element = targetElement;
          }
          
          return instance;
        };
        
        // Copy all static methods and properties
        Object.setPrototypeOf(bootstrap.Modal, OriginalModal);
        bootstrap.Modal.prototype = OriginalModal.prototype;
        Object.assign(bootstrap.Modal, OriginalModal);
        
        // Patch getOrCreateInstance
        if (bootstrap.Modal.getOrCreateInstance) {
          const originalGetOrCreate = bootstrap.Modal.getOrCreateInstance;
          bootstrap.Modal.getOrCreateInstance = function(element, config) {
            console.log('🔍 INTERCEPTED getOrCreateInstance...');
            logToConsole('🔍 INTERCEPTED getOrCreateInstance...');
            
            let targetElement = element;
            
            if (typeof element === 'string') {
              targetElement = document.querySelector(element);
              if (!targetElement) {
                const modalId = element.replace('#', '');
                targetElement = document.createElement('div');
                targetElement.className = 'modal fade';
                targetElement.id = modalId;
                targetElement.innerHTML = '<div class="modal-dialog"><div class="modal-content"><div class="modal-body">Emergency modal created by getOrCreateInstance</div></div></div>';
                document.body.appendChild(targetElement);
                logToConsole('🚨 Created emergency modal in getOrCreateInstance: ' + modalId);
              }
            }
            
            try {
              const instance = originalGetOrCreate.call(this, targetElement, config);
              
              if (instance && !instance._element) {
                logToConsole('🔧 Fixing returned instance with undefined _element');
                instance._element = targetElement;
                instance._config = instance._config || config || {};
              }
              
              logToConsole('✅ getOrCreateInstance completed successfully');
              return instance;
              
            } catch (error) {
              logToConsole('❌ getOrCreateInstance failed: ' + error.message);
              return new bootstrap.Modal(targetElement, config);
            }
          };
        }
        
        console.log('✅ Bootstrap Modal ULTRA-COMPREHENSIVE fix applied');
        logToConsole('✅ Bootstrap Modal ULTRA-COMPREHENSIVE fix applied');
      }
    </script>
    
    <!-- Test Functions -->
    <script>
        function logToConsole(message) {
            const consoleOutput = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            consoleOutput.innerHTML += '[' + timestamp + '] ' + message + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        function clearConsole() {
            document.getElementById('consoleOutput').innerHTML = '';
        }
        
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const indicator = element.querySelector('.status-indicator');
            const textSpan = element.querySelector('span:last-child');
            
            indicator.className = 'status-indicator status-' + status;
            textSpan.className = 'text-' + (status === 'pass' ? 'success' : status === 'fail' ? 'danger' : 'warning');
            textSpan.textContent = message;
        }
        
        function testMissingModal() {
            logToConsole('🧪 TEST: Removing modal and trying to open...');
            const modal = document.getElementById('restoreModal');
            if (modal) {
                modal.remove();
                logToConsole('✅ Modal removed from DOM');
            }
            
            // Try to create instance of non-existent modal
            try {
                const instance = new bootstrap.Modal('#restoreModal');
                logToConsole('✅ Successfully handled missing modal - emergency modal should be created');
                instance.show();
            } catch (error) {
                logToConsole('❌ Failed to handle missing modal: ' + error.message);
            }
        }
        
        function testBrokenBootstrap() {
            logToConsole('🧪 TEST: Simulating Bootstrap constructor failure...');
            
            const originalConstructor = bootstrap.Modal.constructor;
            
            // Temporarily break Bootstrap
            const tempModal = bootstrap.Modal;
            bootstrap.Modal = function() {
                throw new Error('Simulated Bootstrap failure');
            };
            
            try {
                const instance = new bootstrap.Modal('#restoreModal');
                logToConsole('✅ Successfully handled broken Bootstrap with mock instance');
            } catch (error) {
                logToConsole('❌ Failed to handle broken Bootstrap: ' + error.message);
            } finally {
                // Restore
                bootstrap.Modal = tempModal;
            }
        }
        
        function runAllTests() {
            logToConsole('🧪 RUNNING COMPREHENSIVE TEST SUITE...');
            
            // Test 1: Check Bootstrap
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                updateStatus('status-bootstrap', 'pass', 'Bootstrap Loaded Successfully');
                logToConsole('✅ Bootstrap detected and available');
            } else {
                updateStatus('status-bootstrap', 'fail', 'Bootstrap Not Found');
                logToConsole('❌ Bootstrap not detected');
            }
            
            // Test 2: Check Modal Element
            const modal = document.getElementById('restoreModal');
            if (modal) {
                updateStatus('status-modal', 'pass', 'Modal Element Found');
                logToConsole('✅ restoreModal element found in DOM');
            } else {
                updateStatus('status-modal', 'warn', 'Modal Element Missing (Will Create)');
                logToConsole('⚠️ restoreModal element not found - emergency creation will be tested');
            }
            
            // Test 3: Check Fix Patches
            if (bootstrap.Modal.toString().includes('INTERCEPTED')) {
                updateStatus('status-patches', 'pass', 'Fix Patches Applied');
                logToConsole('✅ Modal fix patches detected in Bootstrap.Modal');
            } else {
                updateStatus('status-patches', 'warn', 'Patches May Not Be Applied');
                logToConsole('⚠️ Modal fix patches not clearly detected');
            }
            
            // Test 4: Test Instance Creation
            try {
                const testInstance = new bootstrap.Modal('#restoreModal');
                if (testInstance && testInstance._element) {
                    updateStatus('status-instance', 'pass', 'Instance Creation Working');
                    logToConsole('✅ Modal instance created successfully with valid _element');
                } else {
                    updateStatus('status-instance', 'warn', 'Instance Created But May Have Issues');
                    logToConsole('⚠️ Modal instance created but _element validation failed');
                }
                testInstance.dispose();
            } catch (error) {
                updateStatus('status-instance', 'fail', 'Instance Creation Failed');
                logToConsole('❌ Modal instance creation failed: ' + error.message);
            }
            
            logToConsole('🎉 TEST SUITE COMPLETED');
        }
        
        // Auto-run tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>