<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Modal Fix Test</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Preemptive Modal Fix - Load before any JavaScript -->
    <script>
      // Early intervention for Bootstrap Modal issues
      window.addEventListener('DOMContentLoaded', function() {
        // Set up a global error handler for modal errors
        window.addEventListener('error', function(e) {
          if (e.message && e.message.includes('_config is undefined')) {
            console.warn('üö® Caught modal config error, attempting recovery...');
            
            // Try to find and fix the problematic modal
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
              try {
                const instance = bootstrap?.Modal?.getInstance?.(modal);
                if (instance && !instance._config) {
                  instance._config = { backdrop: true, keyboard: true, focus: true };
                  console.log('üîß Fixed modal config for:', modal.id);
                }
              } catch (fixError) {
                console.warn('Modal fix attempt failed:', fixError);
              }
            });
            
            e.preventDefault();
            return false;
          }
        });
      });
    </script>
</head>
<body>
    <div class="container mt-5">
        <h1>Comprehensive Modal Fix Test</h1>
        <p>This page tests all the modal fixes for Bootstrap errors.</p>
        
        <div class="row">
            <div class="col-md-6">
                <h3>Test Cases</h3>
                <div class="list-group">
                    <!-- Test 1: Normal Modal -->
                    <button type="button" class="list-group-item list-group-item-action" 
                            data-bs-toggle="modal" data-bs-target="#normalModal">
                        Test 1: Normal Modal
                    </button>
                    
                    <!-- Test 2: Restore Modal (replica) -->
                    <button type="button" class="list-group-item list-group-item-action" 
                            data-bs-toggle="modal" data-bs-target="#restoreModal">
                        Test 2: Restore Modal (Replica)
                    </button>
                    
                    <!-- Test 3: Programmatic Modal -->
                    <button type="button" class="list-group-item list-group-item-action" 
                            onclick="testProgrammaticModal()">
                        Test 3: Programmatic Modal
                    </button>
                    
                    <!-- Test 4: Multiple Modals -->
                    <button type="button" class="list-group-item list-group-item-action" 
                            onclick="testMultipleModals()">
                        Test 4: Multiple Modals
                    </button>
                </div>
            </div>
            
            <div class="col-md-6">
                <h3>Test Results</h3>
                <div id="testResults" class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        Running tests...
                    </div>
                </div>
                
                <h4>Console Log</h4>
                <div id="consoleLog" class="bg-dark text-light p-3" style="height: 300px; overflow-y: scroll; font-family: monospace; font-size: 0.8rem;">
                    <!-- Console output will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Test Modals -->
    
    <!-- Normal Modal -->
    <div class="modal fade" id="normalModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Normal Test Modal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>This is a normal modal for testing basic functionality.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Restore Modal Replica -->
    <div class="modal fade" id="restoreModal" tabindex="-1" aria-labelledby="restoreModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="restoreModalLabel">Restore Database (Test)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Test Modal:</strong> This replicates the restore database modal structure.
                    </div>
                    <form id="testRestoreForm">
                        <div class="mb-3">
                            <label for="testBackupFile" class="form-label">Select Test File</label>
                            <input type="file" class="form-control" id="testBackupFile" accept=".zip">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="testConfirm">
                            <label class="form-check-label" for="testConfirm">
                                I understand this is a test
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="testRestoreBtn" disabled>Test Action</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Programmatic Modal -->
    <div class="modal fade" id="programmaticModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Programmatic Modal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>This modal was opened programmatically to test JavaScript creation.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    
    <!-- Modal Fix Implementation -->
    <script>
      // Critical fix for Bootstrap Modal config undefined error
      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        // Patch the Modal prototype directly - Fix both _config and _element issues
        const originalInitBackdrop = bootstrap.Modal.prototype._initializeBackDrop;
        if (originalInitBackdrop) {
          bootstrap.Modal.prototype._initializeBackDrop = function() {
            // Emergency fix: ensure _config exists
            if (!this._config) {
              console.warn('‚ùå Modal _config was undefined, applying emergency fix');
              this._config = { backdrop: true, keyboard: true, focus: true };
            }
            
            // Emergency fix: ensure _element exists
            if (!this._element) {
              console.error('‚ùå Modal _element was undefined, this is critical!');
              return; // Can't proceed without element
            }
            
            if (typeof this._config.backdrop === 'undefined') {
              this._config.backdrop = true;
            }
            
            return originalInitBackdrop.call(this);
          };
        }
        
        // Also patch _isAnimated which is causing the classList error
        const originalIsAnimated = bootstrap.Modal.prototype._isAnimated;
        if (originalIsAnimated) {
          bootstrap.Modal.prototype._isAnimated = function() {
            if (!this._element) {
              console.error('‚ùå Modal _element is undefined in _isAnimated');
              return false; // Default to not animated
            }
            
            if (!this._element.classList) {
              console.error('‚ùå Modal element has no classList property');
              return false;
            }
            
            return originalIsAnimated.call(this);
          };
        }
        
        // Patch constructor
        const OriginalModal = bootstrap.Modal;
        bootstrap.Modal = function(element, config) {
          // Validate element first
          if (!element) {
            console.error('‚ùå Modal element is null/undefined!');
            throw new Error('Modal element cannot be null or undefined');
          }
          
          // Ensure element is a DOM element
          if (typeof element === 'string') {
            const foundElement = document.querySelector(element);
            if (!foundElement) {
              console.error('‚ùå Modal element not found with selector:', element);
              throw new Error(`Modal element not found: ${element}`);
            }
            element = foundElement;
          }
          
          if (!element.classList) {
            console.error('‚ùå Modal element missing classList property');
            throw new Error('Modal element must be a valid DOM element');
          }
          
          config = config || {};
          if (typeof config.backdrop === 'undefined') config.backdrop = true;
          if (typeof config.keyboard === 'undefined') config.keyboard = true;
          if (typeof config.focus === 'undefined') config.focus = true;
          
          const instance = new OriginalModal(element, config);
          
          if (!instance._config) instance._config = config;
          if (!instance._element) instance._element = element;
          
          return instance;
        };
        
        // Copy static methods and properties
        Object.setPrototypeOf(bootstrap.Modal, OriginalModal);
        bootstrap.Modal.prototype = OriginalModal.prototype;
        Object.assign(bootstrap.Modal, OriginalModal);
        
        console.log('‚úÖ Bootstrap Modal emergency fix applied');
      }
    </script>

    <script>
        // Console log capture
        const consoleLogDiv = document.getElementById('consoleLog');
        const originalConsole = {
            log: console.log,
            warn: console.warn,
            error: console.error,
            info: console.info
        };
        
        function addToConsoleLog(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const logEntry = document.createElement('div');
            logEntry.className = `text-${type === 'error' ? 'danger' : type === 'warn' ? 'warning' : 'light'}`;
            logEntry.innerHTML = `<small class="text-muted">[${timestamp}]</small> ${message}`;
            
            consoleLogDiv.appendChild(logEntry);
            consoleLogDiv.scrollTop = consoleLogDiv.scrollHeight;
            
            // Call original console method
            originalConsole[type].apply(console, args);
        }
        
        // Override console methods
        console.log = (...args) => addToConsoleLog('log', ...args);
        console.warn = (...args) => addToConsoleLog('warn', ...args);
        console.error = (...args) => addToConsoleLog('error', ...args);
        console.info = (...args) => addToConsoleLog('info', ...args);

        // Test functions
        function testProgrammaticModal() {
            console.log('üß™ Testing programmatic modal creation...');
            try {
                const modalEl = document.getElementById('programmaticModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
                console.log('‚úÖ Programmatic modal created and shown successfully');
                updateTestResults('programmatic', true);
            } catch (error) {
                console.error('‚ùå Programmatic modal test failed:', error);
                updateTestResults('programmatic', false, error.message);
            }
        }
        
        function testMultipleModals() {
            console.log('üß™ Testing multiple modal instances...');
            try {
                // Test creating multiple instances
                const modal1 = new bootstrap.Modal('#normalModal');
                const modal2 = new bootstrap.Modal('#restoreModal');
                
                modal1.show();
                setTimeout(() => {
                    modal1.hide();
                    modal2.show();
                    setTimeout(() => modal2.hide(), 1000);
                }, 1000);
                
                console.log('‚úÖ Multiple modals test completed');
                updateTestResults('multiple', true);
            } catch (error) {
                console.error('‚ùå Multiple modals test failed:', error);
                updateTestResults('multiple', false, error.message);
            }
        }
        
        let testResults = {
            normal: null,
            restore: null,
            programmatic: null,
            multiple: null
        };
        
        function updateTestResults(test, passed, error = null) {
            testResults[test] = { passed, error };
            renderTestResults();
        }
        
        function renderTestResults() {
            const resultsDiv = document.getElementById('testResults');
            let html = '<h5>Test Results:</h5><ul class="list-unstyled">';
            
            for (const [test, result] of Object.entries(testResults)) {
                if (result === null) {
                    html += `<li>‚è≥ ${test}: Pending</li>`;
                } else if (result.passed) {
                    html += `<li class="text-success">‚úÖ ${test}: Passed</li>`;
                } else {
                    html += `<li class="text-danger">‚ùå ${test}: Failed - ${result.error}</li>`;
                }
            }
            
            html += '</ul>';
            
            const allTested = Object.values(testResults).every(r => r !== null);
            const allPassed = Object.values(testResults).every(r => r && r.passed);
            
            if (allTested) {
                if (allPassed) {
                    html += '<div class="alert alert-success">üéâ All tests passed!</div>';
                } else {
                    html += '<div class="alert alert-danger">‚ùå Some tests failed</div>';
                }
            }
            
            resultsDiv.innerHTML = html;
        }
        
        // Initialize tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Starting modal tests...');
            
            // Test basic Bootstrap availability
            if (typeof bootstrap === 'undefined') {
                console.error('‚ùå Bootstrap not loaded');
                return;
            }
            
            console.log('‚úÖ Bootstrap loaded successfully');
            
            // Test modal creation without showing
            try {
                const testModal = new bootstrap.Modal('#normalModal');
                console.log('‚úÖ Basic modal creation test passed');
                updateTestResults('normal', true);
            } catch (error) {
                console.error('‚ùå Basic modal creation failed:', error);
                updateTestResults('normal', false, error.message);
            }
            
            // Test restore modal structure
            try {
                const restoreModal = new bootstrap.Modal('#restoreModal');
                console.log('‚úÖ Restore modal creation test passed');
                updateTestResults('restore', true);
            } catch (error) {
                console.error('‚ùå Restore modal creation failed:', error);
                updateTestResults('restore', false, error.message);
            }
            
            renderTestResults();
            
            // Add event listeners for modal events
            document.addEventListener('click', function(e) {
                if (e.target.closest('[data-bs-toggle="modal"]')) {
                    console.log('üéØ Modal trigger clicked via event delegation');
                }
            });
        });
    </script>
</body>
</html>