{% extends "base.html" %}
{% block title %}Manage Panel - {{ tenant.name }} - Khudroo{% endblock %}

{% block extra_css %}
<style>
/* Beautiful Billing Card Animations */
#billing-status-card {
    transition: all 0.3s ease;
}

#billing-status-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important;
}

.billing-hours-display, .billing-days-display {
    transition: all 0.5s ease;
    transform-origin: center;
}

.billing-hours-display:hover, .billing-days-display:hover {
    transform: scale(1.1);
}

.billing-progress-bar {
    transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    background: linear-gradient(90deg, currentColor 0%, currentColor 100%);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.billing-notification-badge {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
}

.billing-status-badge {
    transition: all 0.3s ease;
}

.billing-status-badge:hover {
    transform: scale(1.05);
}

/* Beautiful loading animation */
.billing-loading .spinner-border {
    animation: customSpin 1.5s linear infinite;
}

@keyframes customSpin {
    0% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(1.1); }
    100% { transform: rotate(360deg) scale(1); }
}

/* Card state transitions */
.billing-active, .billing-expired, .billing-error {
    animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
    0% { opacity: 0; transform: translateY(20px); }
    100% { opacity: 1; transform: translateY(0); }
}

/* Progress bar glow effect */
.progress-bar.bg-success {
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
}

.progress-bar.bg-warning {
    box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
}

.progress-bar.bg-danger {
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
}

/* Compact Statistics Cards */
.compact-stats-card {
    min-height: 120px;
}

/* Mobile responsive adjustments for compact stats */
@media (max-width: 768px) {
    /* On mobile, only Uptime and Users show, each taking 50% width */
    .compact-stats-card {
        min-height: 120px; /* Keep normal height since only 2 boxes show */
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb" style="background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%); padding: 1rem 1.5rem; border-radius: 12px; border: 1px solid var(--border-primary); box-shadow: var(--shadow-sm);">
        <li class="breadcrumb-item">
          <a href="{{ url_for('dashboard') }}" style="color: var(--primary); text-decoration: none; font-weight: 500;">Dashboard</a>
        </li>
        <li class="breadcrumb-item active" style="color: var(--text-primary); font-weight: 600;">{{ tenant.name }}</li>
      </ol>
    </nav>
    <h2 style="color: var(--text-primary); margin-top: 1.5rem;"><i class="fas fa-cog me-2 text-primary"></i>Manage Panel: {{ tenant.name }}</h2>
  </div>
</div>

<!-- Usage Statistics -->
<div class="row mb-4 g-3">
  <!-- Applications - Hidden on mobile -->
  <div class="col-3 d-none d-md-block">
    <div class="card text-center border-0 shadow-sm h-100 compact-stats-card" style="border-radius: 12px; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='var(--shadow-md)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)'">
      <div class="card-body p-3 d-flex flex-column justify-content-center align-items-center">
        <button type="button" class="btn btn-outline-primary mb-2 compact-stats-btn" data-bs-toggle="modal" data-bs-target="#appManagementModal" style="border-radius: 8px; padding: 0.5rem; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-width: 1px;">
          <i class="fab fa-uncharted text-primary" style="font-size: 1.25rem;"></i>
        </button>
        <h4 class="card-title fw-bold mb-1" style="color: var(--text-primary); font-size: 1.5rem;">{{ modules }}</h4>
        <p class="card-text mb-0" style="color: var(--text-muted); font-size: 0.75rem; font-weight: 500; line-height: 1.2;">Applications</p>
      </div>
    </div>
  </div>
  
  <!-- Storage - Hidden on mobile -->
  <div class="col-3 d-none d-md-block">
    <div class="card text-center border-0 shadow-sm h-100 compact-stats-card" style="border-radius: 12px; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='var(--shadow-md)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)'">
      <div class="card-body p-3 d-flex flex-column justify-content-center align-items-center">
        <div class="mb-2" style="width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-hdd text-info" style="font-size: 1.25rem;"></i>
        </div>
        <h4 class="card-title fw-bold mb-1" style="color: var(--text-primary); font-size: 1.5rem;">{{storage_usage}}</h4>
        <p class="card-text mb-0" style="color: var(--text-muted); font-size: 0.75rem; font-weight: 500; line-height: 1.2;">Storage</p>
      </div>
    </div>
  </div>
  
  <!-- Uptime - 50% width on mobile -->
  <div class="col-3 col-md-3 col-6">
    <div class="card text-center border-0 shadow-sm h-100 compact-stats-card" style="border-radius: 12px; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='var(--shadow-md)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)'">
      <div class="card-body p-3 d-flex flex-column justify-content-center align-items-center">
        <div class="mb-2" style="width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-chart-line text-success" style="font-size: 1.25rem;"></i>
        </div>
        <h4 class="card-title fw-bold mb-1" style="color: var(--text-primary); font-size: 1.5rem;">{{uptime}}</h4>
        <p class="card-text mb-0" style="color: var(--text-muted); font-size: 0.75rem; font-weight: 500; line-height: 1.2;">Uptime</p>
      </div>
    </div>
  </div>
  
  <!-- Users - 50% width on mobile -->
  <div class="col-3 col-md-3 col-6">
    <div class="card text-center border-0 shadow-sm h-100 compact-stats-card" style="border-radius: 12px; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='var(--shadow-md)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)'">
      <div class="card-body p-3 d-flex flex-column justify-content-center align-items-center">
        <div class="mb-2" style="width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-users text-warning" style="font-size: 1.25rem;"></i>
        </div>
        <h4 class="card-title fw-bold mb-1" style="color: var(--text-primary); font-size: 1.5rem;">{{odoo_user}}</h4>
        <p class="card-text mb-0" style="color: var(--text-muted); font-size: 0.75rem; font-weight: 500; line-height: 1.2;">Users</p>
      </div>
    </div>
  </div>
</div>

<!-- Panel Overview - Redesigned -->
<div class="row mb-4">
  <div class="col-md-8">
    <!-- Main Panel Information Card -->
    <div class="card border-0 shadow-sm mb-4" style="border-radius: 16px;">
      <div class="card-header border-0" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-radius: 16px 16px 0 0;">
        <div class="d-flex align-items-center justify-content-between w-100">
          <div class="d-flex align-items-center">
            <div class="p-3 rounded-circle me-3" style="background: rgba(255, 255, 255, 0.2);">
              <i class="fas fa-building text-white fa-lg"></i>
            </div>
            <div>
              <h4 class="mb-1 text-white fw-bold">{{ tenant.name }}</h4>
              <p class="mb-0" style="color: rgba(255, 255, 255, 0.8);">Panel Configuration & Management</p>
            </div>
          </div>
          <div>
            <span class="badge bg-{{ 'success' if tenant.status == 'active' else 'warning' if tenant.status == 'inactive' else 'danger' }}" 
                  style="padding: 0.75rem 1.25rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem;">
              <i class="fas fa-circle me-2" style="font-size: 0.6rem;"></i>
              {{ tenant.status.title() }}
            </span>
          </div>
        </div>
      </div>
      
      <div class="card-body p-4">
        <div class="row g-4">
          <!-- Left Column - Basic Info -->
          <div class="col-md-6">
            <div class="mb-4">
              <h6 class="fw-bold mb-3" style="color: var(--text-primary); font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fas fa-info-circle text-primary me-2"></i>Basic Information
              </h6>
              
              <div class="mb-3">
                <div class="d-flex align-items-start">
                  <div class="me-3 mt-1">
                    <i class="fas fa-tag text-primary" style="font-size: 1.1rem;"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div class="fw-semibold mb-1" style="color: var(--text-secondary); font-size: 0.9rem;">Tenant Name</div>
                    <div class="fw-bold" style="color: var(--text-primary); font-size: 1.1rem;">{{ tenant.name }}</div>
                  </div>
                </div>
              </div>
              
              <div class="mb-3">
                <div class="d-flex align-items-start">
                  <div class="me-3 mt-1">
                    <i class="fas fa-link text-info" style="font-size: 1.1rem;"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div class="fw-semibold mb-1" style="color: var(--text-secondary); font-size: 0.9rem;">Subdomain</div>
                    <div>
                      <a data-tenant-db="{{tenant.database_name}}" 
                         data-tenant-id="{{ tenant.id }}"
                         target="_blank" 
                         class="text-decoration-none tenant-link fw-bold" 
                         style="color: var(--primary); font-size: 1rem;">
                        {{tenant.database_name}}.<domain>
                        <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8rem;"></i>
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="mb-3">
                <div class="d-flex align-items-start">
                  <div class="me-3 mt-1">
                    <i class="fas fa-crown text-warning" style="font-size: 1.1rem;"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div class="fw-semibold mb-1" style="color: var(--text-secondary); font-size: 0.9rem;">Subscription Plan</div>
                    <div>
                      <span class="badge bg-primary" style="padding: 0.6rem 1.2rem; border-radius: 15px; font-weight: 600; font-size: 0.85rem;">
                        {{ tenant.plan.title() }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Single Button to Open Combined Modal -->
              <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#appManagementModal">
                  Manage Applications
              </button>

            </div>
          </div>
          
          <!-- Right Column - Resources & Timeline -->
          <div class="col-md-6">
            <div class="mb-4">
              <h6 class="fw-bold mb-3" style="color: var(--text-primary); font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fas fa-chart-bar text-success me-2"></i>Resource Usage
              </h6>
              
              <div class="mb-3">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-users text-success me-3" style="font-size: 1.1rem;"></i>
                    <div>
                      <div class="fw-semibold" style="color: var(--text-secondary); font-size: 0.9rem;">Users</div>
                      <div class="fw-bold" style="color: var(--text-primary); font-size: 1.1rem;" id="maxUsersDisplay">
                        {% set current_plan = plans|selectattr('name', 'equalto', tenant.plan)|first %}
                        {{ current_plan.max_users if current_plan else tenant.max_users }} max
                      </div>
                    </div>
                  </div>
                  <div class="text-end">
                    <div class="progress mb-1" style="width: 80px; height: 8px;">
                      <div class="progress-bar bg-success" style="width: 65%;"></div>
                    </div>
                    <small class="fw-semibold" style="color: var(--text-secondary);">65% used</small>
                  </div>
                </div>
              </div>
              
              <div class="mb-4">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-hdd text-info me-3" style="font-size: 1.1rem;"></i>
                    <div>
                      <div class="fw-semibold" style="color: var(--text-secondary); font-size: 0.9rem;">Storage</div>
                      <div class="fw-bold" style="color: var(--text-primary); font-size: 1.1rem;" id="storageDisplay">
                        {% set current_plan = plans|selectattr('name', 'equalto', tenant.plan)|first %}
                        {{ current_plan.storage_limit if current_plan else tenant.storage_limit }} MB
                      </div>
                    </div>
                  </div>
                  <div class="text-end">
                    <div class="progress mb-1" style="width: 80px; height: 8px;">
                      <div class="progress-bar bg-info" style="width: 40%;"></div>
                    </div>
                    <small class="fw-semibold" style="color: var(--text-secondary);">40% used</small>
                  </div>
                </div>
              </div>
            </div>
            
            <div>
              <h6 class="fw-bold mb-3" style="color: var(--text-primary); font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fas fa-history text-secondary me-2"></i>Timeline
              </h6>
              
              <div class="row">
                <div class="col-6">
                  <div class="text-center p-3 rounded-3" style="background: var(--bg-secondary);">
                    <i class="fas fa-calendar-plus text-primary mb-2 d-block" style="font-size: 1.5rem;"></i>
                    <div class="fw-semibold mb-1" style="color: var(--text-secondary); font-size: 0.85rem;">Created</div>
                    <div class="fw-bold" style="color: var(--text-primary); font-size: 0.95rem;">{{ tenant.created_at.strftime('%b %d, %Y') }}</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="text-center p-3 rounded-3" style="background: var(--bg-secondary);">
                    <i class="fas fa-sync-alt text-success mb-2 d-block" style="font-size: 1.5rem;"></i>
                    <div class="fw-semibold mb-1" style="color: var(--text-secondary); font-size: 0.85rem;">Updated</div>
                    <div class="fw-bold" style="color: var(--text-primary); font-size: 0.95rem;">{{ tenant.updated_at.strftime('%b %d, %Y') }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Access Credentials Card -->
    <div class="card shadow-lg border-0" style="border-radius: 16px;">
      <div class="card-header border-0" style="background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%); border-radius: 16px 16px 0 0;">
        <div class="d-flex align-items-center">
          <div class="p-2 rounded-circle me-3" style="background: rgba(113, 75, 103, 0.2); color: var(--primary);">
            <i class="fas fa-key"></i>
          </div>
          <div>
            <h5 class="mb-0 fw-semibold" style="color: var(--text-primary);">Access Credentials</h5>
          </div>
        </div>
      </div>
      
      <div class="card-body p-3">
        <div class="row g-2">          
          <!-- Database Name -->
          <div class="col-md-4 col-sm-12">
            <div class="rounded-3 p-3" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-primary); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <!-- Header with icon and label -->
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                  <div class="p-2 rounded-circle me-3" style="background: rgba(40, 167, 69, 0.2); color: var(--success);">
                    <i class="fas fa-database"></i>
                  </div>
                  <small class="fw-semibold" style="color: var(--text-secondary);">Database</small>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="copyText('{{tenant.database_name}}')" title="Copy database name" style="border-radius: 8px;">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
              
              <!-- Full width content field -->
              <div class="w-100">
                <div class="p-2" style="background: rgba(255, 255, 255, 0.1); border-radius: 6px;">
                  <code style="background: transparent; color: var(--text-primary); font-size: 0.9rem; word-break: break-all;">{{tenant.database_name}}</code>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Admin Username -->
          <div class="col-md-4 col-sm-12">
            <div class="rounded-3 p-3" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-primary); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <!-- Header with icon and label -->
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                  <div class="p-2 rounded-circle me-3" style="background: rgba(113, 75, 103, 0.2); color: var(--primary);">
                    <i class="fas fa-user-shield"></i>
                  </div>
                  <small class="fw-semibold" style="color: var(--text-secondary);">Username</small>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="copyText('{{tenant.admin_username}}')" title="Copy username" style="border-radius: 8px;">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
              
              <!-- Full width content field -->
              <div class="w-100">
                <div class="p-2" style="background: rgba(255, 255, 255, 0.1); border-radius: 6px;">
                  <code style="background: transparent; color: var(--text-primary); font-size: 0.9rem; word-break: break-all;">{{tenant.admin_username}}</code>
                </div>
              </div>
            </div>
          </div>

          <!-- Admin Password -->
          <div class="col-md-4 col-sm-12">
            <div class="rounded-3 p-3" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-primary); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              <!-- Header with icon and label -->
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                  <div class="p-2 rounded-circle me-3" style="background: rgba(255, 193, 7, 0.2); color: var(--warning);">
                    <i class="fas fa-key"></i>
                  </div>
                  <small class="fw-semibold" style="color: var(--text-secondary);">Password</small>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-sm btn-outline-primary" type="button" onclick="copyPassword()" title="Copy password" style="border-radius: 8px;">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>
              
              <!-- Full width password field -->
              <div class="d-flex w-100">
                <input type="password" 
                      class="form-control border-0 p-2 flex-grow-1" 
                      style="background: rgba(255, 255, 255, 0.1); color: var(--text-primary); font-family: monospace; font-size: 0.9rem; border-radius: 8px 0px 0px 8px; word-break: break-all;" 
                      value="{{tenant.admin_password}}" 
                      readonly 
                      id="passwordField">
                      <button class="btn btn-sm btn-outline-secondary" type="button" onclick="togglePassword()" id="toggleBtn" style="border-radius: 0px 8px 8px 0px;">
                        <i class="fas fa-eye" id="eyeIcon"></i>
                      </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card-footer text-center py-3 border-0" style="background: linear-gradient(135deg, rgba(13, 202, 240, 0.1) 0%, rgba(13, 202, 240, 0.05) 100%); border-radius: 0 0 16px 16px; border-top: 1px solid var(--border-primary);">
        <small style="color: var(--info);">
          <i class="fas fa-shield-alt me-1"></i>
          Keep these credentials secure
        </small>
      </div>
    </div>
  </div>
  
  <!-- Right column content (unchanged) -->
  <div class="col-md-4">
    <!-- Quick Actions card remains the same -->
    <div class="card shadow-sm border-0" style="border-radius: 16px;">
        <div class="card-header text-white border-0" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-radius: 16px 16px 0 0;">
            <h5 class="mb-0 fw-semibold"><i class="fas fa-tools me-2"></i>Quick Actions</h5>
        </div>
        <div class="card-body p-4">
            <div class="d-grid gap-3">
                <!-- Open Tenant -->
                {% if tenant.is_active %}
                <a data-tenant-db="kdoo_{{ tenant.subdomain }}" 
                   data-tenant-id="{{ tenant.id }}"
                   target="_blank" 
                   class="btn btn-primary db-action-btn tenant-link" 
                   style="border-radius: 12px; padding: 1rem; font-weight: 500;">
                    <i class="fas fa-external-link-alt me-2"></i>Open Tenant
                </a>
                {% else %}
                <button class="btn btn-secondary db-action-btn" disabled style="border-radius: 12px; padding: 1rem; font-weight: 500; opacity: 0.6; cursor: not-allowed;">
                    <i class="fas fa-ban me-2"></i>Tenant Inactive
                </button>
                {% endif %}
                
                <!-- Database Status Toggle -->
                <div class="db-toggle-form rounded-3 p-4" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-primary);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="db-status-{{ 'active' if tenant.is_active else 'inactive' }} me-3">
                                <div class="p-3 rounded-circle" style="background: {{ 'rgba(40, 167, 69, 0.2)' if tenant.is_active else 'rgba(220, 53, 69, 0.2)' }}; color: {{ 'var(--success)' if tenant.is_active else 'var(--danger)' }};">
                                  <i class="fas {{ 'fa-running' if tenant.is_active else 'fa-ban' }} db-status-icon"></i>
                                </div>
                            </div>
                            <div>
                                <div class="db-status-text fw-semibold" style="color: var(--text-primary);">Database Status</div>
                                <small>
                                    <span class="badge bg-{{ 'success' if tenant.is_active else 'danger' }} db-status-badge" style="font-size: 0.75rem;">
                                        <i class="fas fa-circle me-1"></i>{{ 'Active' if tenant.is_active else 'Inactive' }}
                                    </span>
                                </small>
                            </div>
                        </div>
                        <form method="POST" action="{{ url_for('toggle_tenant', tenant_id=tenant.id) }}" class="mb-0">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <label class="db-toggle-switch">
                                <input type="checkbox" {{ 'checked' if tenant.is_active else '' }} onchange="this.form.submit()">
                                <span class="db-toggle-slider"></span>
                            </label>
                        </form>
                    </div>
                </div>
                
                <!-- Other action buttons remain the same -->
                <form method="POST" action="{{ url_for('restart_tenant', tenant_id=tenant.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-warning w-100 db-action-btn" style="border-radius: 12px; padding: 1rem; font-weight: 500;">
                        <i class="fas fa-redo me-2"></i>Restart Instance
                    </button>
                </form>
                
                <form method="POST" action="{{ url_for('backup_tenant', tenant_id=tenant.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-info w-100 db-action-btn" style="border-radius: 12px; padding: 1rem; font-weight: 500;">
                        <i class="fas fa-download me-2"></i>Create Backup
                    </button>
                </form>

                <button class="btn btn-outline-success w-100 db-action-btn" 
                        data-bs-toggle="modal" 
                        data-bs-target="#restoreModal" 
                        style="border-radius: 12px; padding: 1rem; font-weight: 500;">
                    <i class="fas fa-upload me-2"></i>Restore Backup
                </button>
                                
                {% if current_user.is_admin %}
                <form method="POST" action="{{ url_for('delete_tenant', tenant_id=tenant.id) }}" onsubmit="return confirm('Are you sure you want to delete this tenant? This action cannot be undone.')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-danger w-100 db-action-btn" style="border-radius: 12px; padding: 1rem; font-weight: 500;">
                        <i class="fas fa-trash me-2"></i>Delete Tenant
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Billing Status Card -->
    <div class="card shadow-sm border-0 mt-4" style="border-radius: 16px;" id="billing-status-card">
        <div class="card-header text-white border-0" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 16px 16px 0 0;">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <div class="p-2 rounded-circle me-3" style="background: rgba(255, 255, 255, 0.2);">
                        <i class="fas fa-chart-pie text-white"></i>
                    </div>
                    <h5 class="mb-0 fw-semibold">Billing Status</h5>
                </div>
                <div class="billing-notification-badge d-none">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                </div>
            </div>
        </div>
        
        <div class="card-body p-4">
            <!-- Server-side billing information -->
            {% if billing_info and billing_info.get('status') != 'no_active_cycle' and not billing_info.get('is_expired', False) %}
            
            <!-- Active Billing State -->
            <div class="billing-active">
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="text-center">
                            <div class="billing-hours-display fw-bold" style="font-size: 2rem; color: var(--primary);">{{ billing_info.get('hours_used', 0)|round(1) }}</div>
                            <small class="text-muted">Hours Used</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="billing-days-display fw-bold" style="font-size: 2rem; color: var(--success);">{{ billing_info.get('days_remaining', 30) }}</div>
                            <small class="text-muted">Days Remaining</small>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="fw-semibold" style="color: var(--text-primary);">Billing Cycle Progress</small>
                        {% set usage_percent = ((billing_info.get('hours_used', 0) / billing_info.get('total_hours_allowed', 360)) * 100)|round(1) %}
                        <small class="billing-percentage text-muted">{{ usage_percent }}%</small>
                    </div>
                    <div class="progress" style="height: 12px; border-radius: 10px; background-color: #e9ecef;">
                        <div class="progress-bar billing-progress-bar bg-{% if usage_percent > 80 %}danger{% elif usage_percent > 60 %}warning{% else %}success{% endif %}" 
                             style="border-radius: 10px; width: {{ usage_percent }}%;" 
                             role="progressbar" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                </div>
                
                <!-- Billing Details -->
                <div class="row g-3">
                    <div class="col-12">
                        <div class="p-3 rounded" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-primary);">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="billing-cycle-start text-muted small">Started</div>
                                    <div class="fw-semibold small">{{ billing_info.get('cycle_start').strftime('%b %d') if billing_info.get('cycle_start') else '-' }}</div>
                                </div>
                                <div class="col-4">
                                    <div class="billing-cycle-end text-muted small">Ends</div>
                                    <div class="fw-semibold small">{{ billing_info.get('cycle_end').strftime('%b %d') if billing_info.get('cycle_end') else '-' }}</div>
                                </div>
                                <div class="col-4">
                                    <div class="billing-status-text text-muted small">Status</div>
                                    <div class="fw-semibold small">
                                        <span class="badge bg-success billing-status-badge">{{ billing_info.get('status', 'Active').title() }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Early Renewal Button (shown 15 days before expiration) -->
                {% if billing_info.get('can_renew_early', False) %}
                <div class="row g-3 mt-2">
                    <div class="col-12">
                        <div class="text-center">
                            <div class="alert alert-info mb-3" style="border-radius: 12px;">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    You can now renew your package early! Payment will extend your current expiration by 30 days.
                                </small>
                            </div>
                            <form action="{{ url_for('billing.process_payment', tenant_id=tenant.id) }}" method="POST">
                                {{ csrf_token() }}
                                <input type="hidden" name="amount" value="50.00">
                                <button type="submit" class="btn btn-primary px-4 py-2" style="border-radius: 12px; font-weight: 600;">
                                    <i class="fas fa-credit-card me-2"></i>Renew Package Early
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            
            <!-- Expired Billing State -->
            <div class="billing-expired">
                <div class="text-center py-3">
                    <div class="mb-3">
                        <i class="fas fa-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="text-danger mb-2">Billing Cycle Expired</h5>
                    <p class="text-muted mb-3">Your panel has been deactivated due to billing expiry.</p>
                    
                    <!-- Payment Button -->
                    <form action="{{ url_for('billing.process_payment', tenant_id=tenant.id) }}" method="POST" class="mb-3">
                        {{ csrf_token() }}
                        <input type="hidden" name="amount" value="50.00">
                        <button type="submit" class="btn btn-warning px-4 py-2" style="border-radius: 12px; font-weight: 600;">
                            <i class="fas fa-credit-card me-2"></i>Pay to Renew Panel
                        </button>
                    </form>
                    
                    <div class="alert alert-warning mb-0" style="border-radius: 12px;">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            Complete payment to reactivate your panel and restore access.
                        </small>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
  </div>
</div>


<!-- Modals -->
<!-- Restart Modal -->
<div class="modal fade" id="restartModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-redo me-2"></i>Restart Instance</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to restart the tenant instance? This will cause a brief downtime.</p>
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Warning:</strong> All active user sessions will be terminated.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning">Restart Instance</button>
      </div>
    </div>
  </div>
</div>

<!-- Backup Modal -->
<div class="modal fade" id="backupModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-download me-2"></i>Create Backup</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Create a backup of the tenant database and files.</p>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="includeFiles" checked>
          <label class="form-check-label" for="includeFiles">
            Include uploaded files
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info">Create Backup</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-cog me-2"></i>Tenant Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="tenantName" class="form-label">Tenant Name</label>
            <input type="text" class="form-control" id="tenantName" value="{{ tenant.name }}">
          </div>
          
          <div class="mb-3">
            <label for="planSelect" class="form-label">Plan</label>
            <select class="form-select" id="planSelect">
              {% for plan in plans %}
              <option value="{{ plan.name }}" {{ 'selected' if tenant.plan == plan.name }}>
                {{ plan.display_name }} - ${{ "%.2f"|format(plan.price) }}/month
              </option>
              {% endfor %}
            </select>
            <div class="form-text">
              <small id="planDetails" class="text-muted">
                <!-- Plan details will be shown here -->
              </small>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="maxUsers" class="form-label">Max Users</label>
            <input type="number" class="form-control" id="maxUsers" value="{{ tenant.max_users }}">
          </div>
          
          <div class="mb-3">
            <label for="storageLimit" class="form-label">Storage Limit (MB)</label>
            <input type="number" class="form-control" id="storageLimit" value="{{ tenant.storage_limit }}">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveTenantChanges()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- ðŸŽ¨ Beautiful Restore Modal with Animations -->
<div class="modal fade" id="restoreModal" tabindex="-1" aria-labelledby="restoreModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="animation: modalSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);">
        <div class="modal-content" style="
            border-radius: 24px; 
            overflow: hidden; 
            border: none; 
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        ">
            <!-- âœ¨ Stunning Header with Animated Gradient -->
            <div class="modal-header border-0 position-relative" style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
                background-size: 300% 300%;
                animation: gradientShift 8s ease infinite;
                padding: 3rem 3rem 2rem;
            ">
                <!-- Animated Background Particles -->
                <div style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-image: radial-gradient(circle at 20% 30%, rgba(255,255,255,0.1) 2px, transparent 2px),
                                      radial-gradient(circle at 80% 70%, rgba(255,255,255,0.08) 1px, transparent 1px),
                                      radial-gradient(circle at 60% 20%, rgba(255,255,255,0.06) 1.5px, transparent 1.5px);
                    background-size: 100px 100px, 80px 80px, 60px 60px;
                    animation: floatParticles 20s linear infinite;
                "></div>
                
                <div class="d-flex align-items-center w-100 position-relative">
                    <!-- Animated Icon Container -->
                    <div class="me-4" style="
                        width: 80px;
                        height: 80px;
                        border-radius: 50%;
                        background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.1) 100%);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        backdrop-filter: blur(10px);
                        border: 2px solid rgba(255,255,255,0.2);
                        animation: iconFloat 3s ease-in-out infinite;
                        position: relative;
                        overflow: hidden;
                    ">
                        <!-- Icon Shimmer Effect -->
                        <div style="
                            position: absolute;
                            top: -50%;
                            left: -50%;
                            width: 200%;
                            height: 200%;
                            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.3) 50%, transparent 70%);
                            animation: shimmer 2.5s ease-in-out infinite;
                        "></div>
                        <i class="fas fa-database text-white" style="font-size: 2.2rem; position: relative;"></i>
                    </div>
                    
                    <!-- Animated Title Section -->
                    <div style="flex: 1;">
                        <h3 class="modal-title text-white fw-bold mb-2" id="restoreModalLabel" style="
                            font-size: 2rem;
                            letter-spacing: -0.5px;
                            text-shadow: 0 2px 20px rgba(0,0,0,0.3);
                            animation: titleSlideIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both;
                        ">
                            Restore Database
                        </h3>
                        <p class="mb-0 text-white-50" style="
                            font-size: 1rem;
                            font-weight: 400;
                            opacity: 0.9;
                            animation: subtitleFadeIn 0.8s ease-out 0.4s both;
                        ">
                            <i class="fas fa-magic me-2"></i>Transform your data with secure restoration
                        </p>
                    </div>
                </div>
                
                <!-- Enhanced Close Button -->
                <button type="button" class="btn-close position-absolute" data-bs-dismiss="modal" aria-label="Close" style="
                    top: 20px;
                    right: 20px;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    background: rgba(255,255,255,0.2) !important;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.3) !important;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    opacity: 1 !important;
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.1) rotate(90deg)'" 
                   onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1) rotate(0deg)'">
                </button>
            </div>
            
            <!-- ðŸŽ¯ Beautiful Modal Body -->
            <div class="modal-body" style="padding: 3rem; background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);">
                <form method="POST" action="{{ url_for('restore_tenant', tenant_id=tenant.id) }}" enctype="multipart/form-data" id="restoreForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    

                    <!-- ðŸ“ Stunning File Upload Section -->
                    <div class="mb-5" style="animation: uploadSlideIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.4s both;">
                        <label for="backupFile" class="form-label fw-bold mb-4 d-block" style="color: #1f2937; font-size: 1.1rem;">
                            <i class="fas fa-cloud-upload-alt me-2" style="color: #10b981;"></i>
                            Choose Your Backup File
                        </label>
                        
                        <!-- Beautiful Drag & Drop Upload Area -->
                        <div id="uploadArea" class="position-relative" style="
                            border: 3px dashed #d1d5db;
                            border-radius: 20px;
                            padding: 3rem 2rem;
                            text-align: center;
                            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
                            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                            cursor: pointer;
                            overflow: hidden;
                        " onclick="document.getElementById('backupFile').click()"
                           onmouseover="this.style.borderColor='#10b981'; this.style.background='linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 20px 40px rgba(16, 185, 129, 0.15)'"
                           onmouseout="this.style.borderColor='#d1d5db'; this.style.background='linear-gradient(135deg, #ffffff 0%, #f9fafb 100%)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                           ondragover="event.preventDefault(); this.style.borderColor='#10b981'; this.style.background='linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%)'"
                           ondragleave="this.style.borderColor='#d1d5db'; this.style.background='linear-gradient(135deg, #ffffff 0%, #f9fafb 100%)'"
                           ondrop="handleFileDrop(event)">
                            
                            <!-- Upload Animation Background -->
                            <div style="
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                width: 150px;
                                height: 150px;
                                border-radius: 50%;
                                background: radial-gradient(circle, rgba(16, 185, 129, 0.05) 0%, transparent 70%);
                                animation: uploadPulse 3s ease-in-out infinite;
                            "></div>
                            
                            <!-- Upload Icon -->
                            <div class="mb-4" style="position: relative;">
                                <div style="
                                    width: 80px;
                                    height: 80px;
                                    margin: 0 auto;
                                    border-radius: 50%;
                                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    box-shadow: 0 12px 32px rgba(16, 185, 129, 0.3);
                                    animation: iconBounce 2s ease-in-out infinite;
                                ">
                                    <i class="fas fa-cloud-upload-alt text-white" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                            
                            <!-- Upload Text -->
                            <div>
                                <h5 class="fw-bold mb-2" style="color: #1f2937;">
                                    Drop your backup file here
                                </h5>
                                <p class="text-muted mb-3" style="font-size: 1rem;">
                                    or <span style="color: #10b981; font-weight: 600;">click to browse</span>
                                </p>
                                <div class="d-flex justify-content-center gap-3 mb-3">
                                    <span class="badge" style="background: #10b981; color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem;">ZIP</span>
                                    <span class="badge" style="background: #3b82f6; color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem;">SQL</span>
                                    <span class="badge" style="background: #8b5cf6; color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem;">GZ</span>
                                    <span class="badge" style="background: #f59e0b; color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem;">TAR.GZ</span>
                                </div>
                                <small class="text-muted">Maximum file size: 500MB</small>
                            </div>
                            
                            <!-- Selected File Display -->
                            <div id="selectedFileDisplay" style="display: none; margin-top: 1.5rem;">
                                <div class="d-inline-flex align-items-center px-4 py-3 rounded-pill" style="
                                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                    color: white;
                                    font-weight: 600;
                                    box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
                                ">
                                    <i class="fas fa-file-archive me-2"></i>
                                    <span id="selectedFileName"></span>
                                    <i class="fas fa-check-circle ms-2"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden File Input -->
                        <input type="file" 
                               class="d-none" 
                               id="backupFile" 
                               name="backup_file" 
                               accept=".zip,.sql,.gz,.tar.gz" 
                               required
                               onchange="handleFileSelect(event)">
                    </div>

                    <!-- âœ… Beautiful Confirmation Section -->
                    <div class="mb-4" style="animation: confirmSlideIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.5s both;">
                        <div class="p-4 rounded-3 position-relative" style="
                            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                            border: 2px solid #f59e0b;
                            box-shadow: 0 8px 32px rgba(245, 158, 11, 0.1);
                            overflow: hidden;
                        ">
                            <!-- Background Pattern -->
                            <div style="
                                position: absolute;
                                top: -10px;
                                right: -10px;
                                width: 60px;
                                height: 60px;
                                background: radial-gradient(circle, rgba(245, 158, 11, 0.1) 0%, transparent 70%);
                            "></div>
                            
                            <div class="form-check d-flex align-items-center position-relative">
                                <div class="me-3" style="
                                    width: 24px;
                                    height: 24px;
                                    position: relative;
                                ">
                                    <input class="form-check-input m-0" 
                                           type="checkbox" 
                                           id="confirmRestore" 
                                           name="confirm_restore" 
                                           required
                                           style="
                                               width: 24px;
                                               height: 24px;
                                               border: 3px solid #f59e0b;
                                               border-radius: 6px;
                                               background: white;
                                               transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                           "
                                           onchange="toggleConfirmation(this)">
                                </div>
                                <label class="form-check-label fw-bold flex-grow-1" for="confirmRestore" style="
                                    color: #92400e;
                                    font-size: 1rem;
                                    line-height: 1.5;
                                    cursor: pointer;
                                ">
                                    <i class="fas fa-shield-alt me-2"></i>
                                    I acknowledge that this action will completely replace the current database and cannot be reversed
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- ðŸŽŠ Beautiful Footer -->
            <div class="modal-footer border-0 p-4" style="
                background: linear-gradient(180deg, #f9fafb 0%, #f3f4f6 100%);
                border-radius: 0 0 24px 24px;
            ">
                <div class="d-flex gap-3 w-100">
                    <button type="button" class="btn btn-outline-secondary flex-fill" data-bs-dismiss="modal" style="
                        border-radius: 16px;
                        padding: 1rem 2rem;
                        font-weight: 600;
                        font-size: 1rem;
                        border: 2px solid #d1d5db;
                        color: #6b7280;
                        background: white;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.1)'; this.style.borderColor='#9ca3af'"
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'; this.style.borderColor='#d1d5db'">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    
                    <button type="submit" 
                            class="btn btn-danger flex-fill"
                            id="restoreSubmitBtn"
                            form="restoreForm"
                            disabled
                            style="
                                border-radius: 16px;
                                padding: 1rem 2rem;
                                font-weight: 600;
                                font-size: 1rem;
                                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                                border: none;
                                box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);
                                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                position: relative;
                                overflow: hidden;
                            "
                            onmouseover="if (!this.disabled) { this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 32px rgba(239, 68, 68, 0.4)'; }"
                            onmouseout="if (!this.disabled) { this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 24px rgba(239, 68, 68, 0.3)'; }">
                        <span id="btnText">
                            <i class="fas fa-upload me-2"></i>Restore Database
                        </span>
                        <div id="btnLoader" style="display: none;">
                            <i class="fas fa-spinner fa-spin me-2"></i>Restoring...
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
{% if current_user.is_admin %}
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fas fa-trash me-2"></i>Delete Tenant</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>This action cannot be undone!</strong>
        </div>
        <p>Are you sure you want to delete the tenant "<strong>{{ tenant.name }}</strong>"?</p>
        <p>This will permanently delete:</p>
        <ul>
          <li>All tenant data and databases</li>
          <li>All user accounts and settings</li>
          <li>All uploaded files and documents</li>
        </ul>
        <div class="mb-3">
          <label for="confirmDelete" class="form-label">Type <strong>{{ tenant.name }}</strong> to confirm:</label>
          <input type="text" class="form-control" id="confirmDelete" placeholder="Tenant name">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>Delete Tenant</button>
      </div>
    </div>
  </div>
</div>

<!-- Combined Apps Modal -->
<div class="modal fade" id="appManagementModal" tabindex="-1" aria-labelledby="appManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="appManagementModalLabel">Application Management</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Left Side: Available Apps -->
                    <div class="col-md-6 border-end app-scroll-container">
                        <h6 class="text-center mb-3" style="color: var(--text-primary);">Available Applications</h6>
                        <div class="row" id="availableAppsList">
                            <!-- Available apps will be populated dynamically -->
                        </div>
                    </div>
                    <!-- Right Side: Installed Apps -->
                    <div class="col-md-6 app-scroll-container">
                        <h6 class="text-center mb-3" style="color: var(--text-primary);">Installed Applications</h6>
                        <div class="row" id="installedAppsList">
                            <!-- Installed apps will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Plan data from backend
const planData = {{ plans|tojson }};

// Auto-refresh status every 30 seconds
setInterval(function() {
    $.ajax({
        url: '/api/tenant/{{ tenant.id }}/status',
        method: 'GET',
        dataType: 'json',
        timeout: 10000,
        success: function(data) {
            // Update status badge with proper type checking and error handling
            try {
                console.log('Received tenant status data:', data);
                
                // Check if we actually got JSON data
                if (typeof data === 'string') {
                    console.warn('Received string instead of JSON, possible authentication issue');
                    return;
                }
                
                const statusBadge = $('.badge:contains("{{ tenant.status.title() }}")');
                statusBadge.removeClass('bg-success bg-warning bg-danger');
                
                // Ensure data.status is a string before calling charAt
                let status = 'unknown';
                if (data && data.status) {
                    if (typeof data.status === 'string' && data.status.trim()) {
                        status = data.status.trim();
                    } else if (typeof data.status === 'object') {
                        // Handle case where status is an object
                        console.log('Status is an object:', data.status);
                        
                        // Try common object properties that might contain the actual status
                        if (data.status.value) {
                            status = String(data.status.value);
                        } else if (data.status.status) {
                            status = String(data.status.status);
                        } else if (data.status.name) {
                            status = String(data.status.name);
                        } else if (data.status.text) {
                            status = String(data.status.text);
                        } else {
                            // If none of the common properties exist, show the first enumerable property
                            const keys = Object.keys(data.status);
                            if (keys.length > 0) {
                                status = String(data.status[keys[0]]);
                                console.log(`Using first property '${keys[0]}':`, status);
                            } else {
                                status = 'unknown';
                            }
                        }
                    } else {
                        // Convert other types (number, boolean, etc.) to string
                        status = String(data.status);
                    }
                }
                
                console.log('Processed status:', status);
                statusBadge.addClass('bg-' + (status === 'active' ? 'success' : 'warning'));
                statusBadge.text(status.charAt(0).toUpperCase() + status.slice(1));
            } catch (error) {
                console.error('Error updating status badge:', error);
                console.log('Data received:', data);
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.error('Failed to fetch tenant status:', textStatus, errorThrown);
            console.log('Response text:', jqXHR.responseText?.substring(0, 200));
            
            // Check if we got redirected to login
            if (jqXHR.responseText && jqXHR.responseText.includes('login')) {
                console.warn('Authentication issue - got redirected to login page');
            }
        }
    });
}, 30000);

// Handle plan selection changes
document.addEventListener('DOMContentLoaded', function() {
    // Ensure document body exists
    if (!document.body) {
        console.warn('Document body not available, skipping plan selection setup');
        return;
    }
    
    const planSelect = document.getElementById('planSelect');
    const maxUsersInput = document.getElementById('maxUsers');
    const storageLimitInput = document.getElementById('storageLimit');
    
    // Create plan lookup object for quick access
    const planLookup = {};
    planData.forEach(plan => {
        planLookup[plan.name] = plan;
    });
    
    // Update fields when plan changes
    planSelect.addEventListener('change', function() {
        const selectedPlan = planLookup[this.value];
        if (selectedPlan) {
            maxUsersInput.value = selectedPlan.max_users;
            storageLimitInput.value = selectedPlan.storage_limit;
            
            // Update plan details display
            updatePlanDetails(selectedPlan);
            
            // Also update the display in the main page
            updateMainPageDisplay(selectedPlan);
        }
    });
    
    // Initialize plan details on page load
    const currentPlan = planLookup[planSelect.value];
    if (currentPlan) {
        updatePlanDetails(currentPlan);
    }
    
    function updatePlanDetails(plan) {
        const planDetails = document.getElementById('planDetails');
        if (planDetails) {
            planDetails.innerHTML = `
                <i class="fas fa-users"></i> ${plan.max_users} users â€¢ 
                <i class="fas fa-hdd"></i> ${plan.storage_limit} MB storage â€¢ 
                <i class="fas fa-dollar-sign"></i> $${plan.price.toFixed(2)}/month
            `;
        }
    }
    
    function updateMainPageDisplay(plan) {
        // Update the max users display in the resource usage section
        const maxUsersDisplay = document.getElementById('maxUsersDisplay');
        if (maxUsersDisplay) {
            maxUsersDisplay.textContent = plan.max_users + ' max';
        }
        
        // Update the storage display in the resource usage section
        const storageDisplay = document.getElementById('storageDisplay');
        if (storageDisplay) {
            storageDisplay.textContent = plan.storage_limit + ' MB';
        }
    }
});

// Save tenant changes function
function saveTenantChanges() {
    const tenantName = document.getElementById('tenantName').value;
    const planSelect = document.getElementById('planSelect').value;
    const maxUsers = document.getElementById('maxUsers').value;
    const storageLimit = document.getElementById('storageLimit').value;
    
    const data = {
        name: tenantName,
        plan: planSelect,
        max_users: parseInt(maxUsers),
        storage_limit: parseInt(storageLimit)
    };
    
    // Show loading state
    const saveBtn = document.querySelector('.btn-primary[onclick="saveTenantChanges()"]');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Saving...';
    saveBtn.disabled = true;
    
    fetch(`/api/tenant/{{ tenant.id }}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Update the main page displays
            if (result.plan_changed) {
                location.reload(); // Reload to reflect all changes
            } else {
                // Just update the displays
                const maxUsersDisplay = document.getElementById('maxUsersDisplay');
                if (maxUsersDisplay) {
                    maxUsersDisplay.textContent = data.max_users + ' max';
                }
                
                const storageDisplay = document.getElementById('storageDisplay');
                if (storageDisplay) {
                    storageDisplay.textContent = data.storage_limit + ' MB';
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                modal.hide();
            }
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving changes.');
    })
    .finally(() => {
        // Reset button state
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
    });
}

// Delete confirmation
document.getElementById('confirmDelete')?.addEventListener('input', function() {
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const tenantName = '{{ tenant.name }}';
    confirmBtn.disabled = this.value !== tenantName;
});

function copyText(text) {
    // Check if clipboard API is available
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            showCopyFeedback();
        }).catch(() => {
            fallbackCopyText(text);
        });
    } else {
        fallbackCopyText(text);
    }
    
    function fallbackCopyText(text) {
        // Fallback for HTTP or unsupported browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showCopyFeedback();
        } catch (err) {
            console.error('Failed to copy text: ', err);
        }
        document.body.removeChild(textArea);
    }
    
    function showCopyFeedback() {
        // Show feedback
        const copyBtn = event.target.closest('button');
        const originalContent = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check text-success"></i>';
        setTimeout(() => {
            copyBtn.innerHTML = originalContent;
        }, 1500);
    }
}

function togglePassword() {
    const passwordField = document.getElementById('passwordField');
    const eyeIcon = document.getElementById('eyeIcon');
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        eyeIcon.classList.remove('fa-eye');
        eyeIcon.classList.add('fa-eye-slash');
    } else {
        passwordField.type = 'password';
        eyeIcon.classList.remove('fa-eye-slash');
        eyeIcon.classList.add('fa-eye');
    }
}

function copyPassword() {
    const passwordField = document.getElementById('passwordField');
    const password = passwordField.value;
    
    // Check if clipboard API is available
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(password).then(() => {
            showPasswordCopyFeedback();
        }).catch(() => {
            fallbackCopyPassword(password);
        });
    } else {
        fallbackCopyPassword(password);
    }
    
    function fallbackCopyPassword(text) {
        // Fallback for HTTP or unsupported browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showPasswordCopyFeedback();
        } catch (err) {
            console.error('Failed to copy password: ', err);
        }
        document.body.removeChild(textArea);
    }
    
    function showPasswordCopyFeedback() {
        // Show feedback
        const copyBtn = event.target.closest('button');
        const originalContent = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check text-success"></i>';
        setTimeout(() => {
            copyBtn.innerHTML = originalContent;
        }, 2000);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const tenantId = {{ tenant_id | tojson }};
    if (!tenantId || tenantId === "undefined" || tenantId === null) {
        console.error('Tenant ID is undefined. Ensure tenant.id is passed correctly in manage_tenant.html');
        AppUtils.showNotification('Error: Tenant ID not found', 'danger');
        return;
    }
    window.tenantId = tenantId;
    // Trigger log fetching and SocketIO initialization
    fetchLogs(tenantId);
    initSocketIO(tenantId);
});

document.addEventListener('DOMContentLoaded', function() {
    // Function to fetch and populate apps with animation
    function populateApps(endpoint, containerId) {
        fetch(endpoint, {
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch apps');
            }
            return response.json();
        })
        .then(data => {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear existing content
            
            if (data.apps && data.apps.length > 0) {
                data.apps.forEach((app, index) => {
                    console.log('Debug: App data:', app); // Debug log for app data
                    const appCard = document.createElement('div');
                    appCard.className = 'col-md-6 mb-3';
                    appCard.style.opacity = '0';
                    appCard.style.transform = 'scale(0.7)';
                    appCard.innerHTML = `
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-body text-center">
                                <img src="${window.location.protocol}//{{tenant.database_name}}.${window.location.host}${app.icon || '/base/static/description/icon.png'}" 
                                     alt="${app.name}" 
                                     class="img-fluid mb-3 app-icon" 
                                     style="max-width: 64px; max-height: 64px;">
                                <h5 class="card-title">${app.name}</h5>
                                <p class="card-text small" style="color: var(--text-muted);">${app.summary || 'No description available'}</p>
                                <p class="card-text small">
                                    <strong>Category:</strong> ${app.category || 'Uncategorized'}<br>
                                    <strong>Version:</strong> ${app.version || 'N/A'}
                                </p>
                                ${app.can_install !== undefined ? `
                                    <button class="btn btn-sm ${app.can_install ? 'btn-primary' : 'btn-secondary disabled'} install-btn" 
                                            data-app="${app.technical_name}"
                                            ${!app.can_install ? 'disabled' : ''}>
                                        ${app.can_install ? 'Install' : 'Not Installable'}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(appCard);

                    // Add pop animation with slight delay for each card
                    setTimeout(() => {
                        appCard.style.transition = 'all 0.3s ease-in-out';
                        appCard.style.opacity = '1';
                        appCard.style.transform = 'scale(1)';
                    }, index * 100);
                });
            } else {
                container.innerHTML = '<p style="color: var(--text-muted);" class="text-center">No applications available.</p>';
            }
        })
        .catch(error => {
            console.error('Error fetching apps:', error);
            const container = document.getElementById(containerId);
            container.innerHTML = '<p class="text-danger text-center">Failed to load applications.</p>';
        });
    }

    // Populate both available and installed apps when modal is shown
    const appManagementModal = document.getElementById('appManagementModal');
    if (appManagementModal) {
        appManagementModal.addEventListener('show.bs.modal', function() {
            populateApps(`/api/tenant/${tenantId}/apps/available`, 'availableAppsList');
            populateApps(`/api/tenant/${tenantId}/apps/installed`, 'installedAppsList');
        });
    }
});

// Backup/Restore functionality
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('backupFile');
    const confirmCheckbox = document.getElementById('confirmRestore');
    const restoreBtn = document.getElementById('confirmRestoreBtn');
    const fileNameDisplay = document.querySelector('.file-name-display');
    const fileName = document.querySelector('.file-name');
    const uploadArea = document.querySelector('.file-upload-area');
    
    // Only proceed if all elements exist
    if (!fileInput || !confirmCheckbox || !restoreBtn || !fileNameDisplay || !fileName || !uploadArea) {
        console.log('Backup/restore elements not found, skipping initialization');
        return;
    }
    
    // File selection handler
    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const file = this.files[0];
            fileName.textContent = file.name;
            fileNameDisplay.style.display = 'block';
            uploadArea.style.borderColor = 'var(--success)';
            uploadArea.style.background = 'linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%)';
            checkFormValidity();
        }
    });
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--success)';
        this.style.background = 'linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%)';
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--border-primary)';
        this.style.background = 'linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%)';
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].name.endsWith('.zip')) {
            fileInput.files = files;
            fileInput.dispatchEvent(new Event('change'));
        }
    });
    
    // Checkbox handler
    confirmCheckbox.addEventListener('change', checkFormValidity);
    
    function checkFormValidity() {
        const hasFile = fileInput.files && fileInput.files[0];
        const isConfirmed = confirmCheckbox.checked;
        
        restoreBtn.disabled = !(hasFile && isConfirmed);
        
        if (hasFile && isConfirmed) {
            restoreBtn.classList.remove('btn-outline-success');
            restoreBtn.classList.add('btn-success');
        } else {
            restoreBtn.classList.remove('btn-success');
            restoreBtn.classList.add('btn-outline-success');
        }
    }
});

function submitRestoreForm() {
    console.log('ðŸš€ RESTORE FORM SUBMISSION STARTED');
    
    const btn = document.getElementById('confirmRestoreBtn');
    const btnText = btn.querySelector('.btn-text');
    const form = document.getElementById('restoreForm');
    const fileInput = document.getElementById('backupFile');
    
    // Log form state
    console.log('ðŸ“‹ FORM STATE ANALYSIS:');
    console.log('   - Form action:', form.action);
    console.log('   - Form method:', form.method);
    console.log('   - Form enctype:', form.enctype);
    console.log('   - Button disabled:', btn.disabled);
    
    // Log file state
    if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        console.log('ðŸ“ FILE DETAILS:');
        console.log('   - Name:', file.name);
        console.log('   - Size:', file.size, 'bytes');
        console.log('   - Type:', file.type);
        console.log('   - Last Modified:', new Date(file.lastModified));
    } else {
        console.error('âŒ No file selected');
    }
    
    // Log form data
    const formData = new FormData(form);
    console.log('ðŸ“ FORM DATA:');
    for (let [key, value] of formData.entries()) {
        if (value instanceof File) {
            console.log(`   - ${key}: [File] ${value.name} (${value.size} bytes)`);
        } else {
            console.log(`   - ${key}: ${value}`);
        }
    }
    
    // Add loading state
    console.log('ðŸ”„ Setting loading state...');
    btn.disabled = true;
    btnText.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Restoring...';
    
    // Log submission
    console.log('ðŸ“¤ Submitting form to backend...');
    console.log('   - Timestamp:', new Date().toISOString());
    console.log('   - User Agent:', navigator.userAgent);
    
    // Submit form
    try {
        form.submit();
        console.log('âœ… Form submitted successfully');
    } catch (error) {
        console.error('âŒ Form submission failed:', error);
        
        // Reset button state on error
        btn.disabled = false;
        btnText.innerHTML = '<i class="fas fa-upload me-2"></i>Restore Database';
    }
}

// Simplified billing status management (server-side rendered)
document.addEventListener('DOMContentLoaded', function() {
    // Set header color based on billing status
    const billingCard = document.getElementById('billing-status-card');
    const isExpired = {{ 'true' if not billing_info or billing_info.get('is_expired', False) else 'false' }};
    const header = billingCard.querySelector('.card-header');
    
    if (isExpired) {
        header.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
    } else {
        const usagePercent = {{ ((billing_info.get('hours_used', 0) / billing_info.get('total_hours_allowed', 360)) * 100)|round(1) if billing_info else 0 }};
        if (usagePercent > 80) {
            header.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
        } else if (usagePercent > 60) {
            header.style.background = 'linear-gradient(135deg, #ffc107 0%, #e0a800 100%)';
        } else {
            header.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
        }
    }
});

// ðŸ”¥ All modal functionality is handled by the nuclear fix in base.html
// The nuclear fix intercepts all modal clicks and handles them safely
console.log('ðŸ“„ Tenant management page loaded - using nuclear modal fix from base.html');

// âœ¨ BEAUTIFUL RESTORE MODAL ANIMATIONS & INTERACTIONS âœ¨
const style = document.createElement('style');
style.textContent = `
    /* ðŸŽ¨ Beautiful Modal Animations */
    @keyframes modalSlideIn {
        0% { transform: translateY(-50px) scale(0.95); opacity: 0; }
        100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    
    @keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }
    
    @keyframes floatParticles {
        0% { background-position: 0px 0px, 0px 0px, 0px 0px; }
        100% { background-position: 100px 100px, 80px 80px, 60px 60px; }
    }
    
    @keyframes iconFloat {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-8px); }
    }
    
    @keyframes shimmer {
        0% { transform: rotate(0deg) translateX(-200%); }
        100% { transform: rotate(0deg) translateX(200%); }
    }
    
    @keyframes titleSlideIn {
        0% { transform: translateX(-30px); opacity: 0; }
        100% { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes subtitleFadeIn {
        0% { opacity: 0; transform: translateY(10px); }
        100% { opacity: 0.9; transform: translateY(0); }
    }
    
    @keyframes alertSlideIn {
        0% { transform: translateX(-20px); opacity: 0; }
        100% { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes uploadSlideIn {
        0% { transform: translateY(20px); opacity: 0; }
        100% { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes confirmSlideIn {
        0% { transform: translateX(20px); opacity: 0; }
        100% { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes warningPulse {
        0%, 100% { transform: scale(1); box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3); }
        50% { transform: scale(1.05); box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4); }
    }
    
    @keyframes iconBounce {
        0%, 100% { transform: translateY(0px) scale(1); }
        50% { transform: translateY(-5px) scale(1.05); }
    }
    
    @keyframes uploadPulse {
        0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.1; }
        50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.2; }
    }
    
    /* ðŸŽ¯ Enhanced Upload Area States */
    .upload-area-active {
        border-color: #10b981 !important;
        background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%) !important;
        transform: scale(1.02) !important;
        box-shadow: 0 20px 40px rgba(16, 185, 129, 0.2) !important;
    }
    
    .upload-area-success {
        border-color: #10b981 !important;
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%) !important;
        animation: successPulse 0.8s ease-out;
    }
    
    @keyframes successPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
    
    /* âœ¨ Button Loading Animation */
    .btn-loading {
        position: relative;
        overflow: hidden;
    }
    
    .btn-loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        animation: buttonShimmer 1.5s infinite;
    }
    
    @keyframes buttonShimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    /* ðŸŽ¨ Form Validation States */
    .form-control-success {
        border-color: #10b981 !important;
        box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25) !important;
    }
    
    .form-control-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 0.2rem rgba(239, 68, 68, 0.25) !important;
        animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
`;
document.head.appendChild(style);

// ðŸŽ¯ File Upload Handling with Drag & Drop
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        displaySelectedFile(file);
        validateForm();
    }
}

function handleFileDrop(event) {
    event.preventDefault();
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.style.borderColor = '#d1d5db';
    uploadArea.style.background = 'linear-gradient(135deg, #ffffff 0%, #f9fafb 100%)';
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        document.getElementById('backupFile').files = files;
        displaySelectedFile(file);
        validateForm();
    }
}

function displaySelectedFile(file) {
    const uploadArea = document.getElementById('uploadArea');
    const selectedFileDisplay = document.getElementById('selectedFileDisplay');
    const selectedFileName = document.getElementById('selectedFileName');
    
    // Show success state
    uploadArea.classList.add('upload-area-success');
    selectedFileDisplay.style.display = 'block';
    selectedFileName.textContent = file.name;
    
    // Add success animation
    setTimeout(() => {
        uploadArea.classList.remove('upload-area-success');
    }, 800);
    
    console.log('âœ… File selected:', file.name, 'Size:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
}

// âœ… Form Validation & Confirmation Handling
function toggleConfirmation(checkbox) {
    validateForm();
    
    // Add visual feedback
    if (checkbox.checked) {
        checkbox.style.background = '#10b981';
        checkbox.style.borderColor = '#10b981';
        checkbox.style.transform = 'scale(1.1)';
        
        setTimeout(() => {
            checkbox.style.transform = 'scale(1.2)';
        }, 150);
    } else {
        checkbox.style.background = 'white';
        checkbox.style.borderColor = '#f59e0b';
        checkbox.style.transform = 'scale(1.2)';
    }
}

function validateForm() {
    const fileInput = document.getElementById('backupFile');
    const checkbox = document.getElementById('confirmRestore');
    const submitBtn = document.getElementById('restoreSubmitBtn');
    
    const hasFile = fileInput.files && fileInput.files.length > 0;
    const isConfirmed = checkbox.checked;
    const isValid = hasFile && isConfirmed;
    
    // Update submit button state
    submitBtn.disabled = !isValid;
    
    if (isValid) {
        submitBtn.style.opacity = '1';
        submitBtn.style.transform = 'scale(1)';
        submitBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
        submitBtn.style.boxShadow = '0 8px 24px rgba(239, 68, 68, 0.3)';
    } else {
        submitBtn.style.opacity = '0.6';
        submitBtn.style.transform = 'scale(0.98)';
        submitBtn.style.background = '#9ca3af';
        submitBtn.style.boxShadow = 'none';
    }
    
    // Add file input validation styling
    if (hasFile) {
        fileInput.classList.add('form-control-success');
        fileInput.classList.remove('form-control-error');
    }
    
    console.log('ðŸ” Form validation:', { hasFile, isConfirmed, isValid });
}

// ðŸš€ Form Submission with Loading States
document.getElementById('restoreForm').addEventListener('submit', function(event) {
    event.preventDefault();
    
    const submitBtn = document.getElementById('restoreSubmitBtn');
    const btnText = document.getElementById('btnText');
    const btnLoader = document.getElementById('btnLoader');
    
    console.log('ðŸ“¤ Form submission started');
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.classList.add('btn-loading');
    btnText.style.display = 'none';
    btnLoader.style.display = 'block';
    
    // Simulate processing (replace with actual form submission)
    setTimeout(() => {
        console.log('âœ… Form submission completed (simulated)');
        
        // Show success state
        btnLoader.innerHTML = '<i class="fas fa-check me-2"></i>Restore Complete!';
        submitBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        submitBtn.style.boxShadow = '0 8px 24px rgba(16, 185, 129, 0.4)';
        
        setTimeout(() => {
            // Reset form or close modal
            btnText.style.display = 'block';
            btnLoader.style.display = 'none';
            submitBtn.classList.remove('btn-loading');
            submitBtn.disabled = false;
            console.log('ðŸ”„ Form reset completed');
        }, 2000);
        
    }, 3000);
});

// ðŸŽ¨ Modal Enhancement on Show
document.getElementById('restoreModal').addEventListener('show.bs.modal', function() {
    console.log('ðŸŽ­ Beautiful restore modal opening...');
    
    // Reset form state
    validateForm();
    
    // Add entrance animations
    const modal = this;
    const alerts = modal.querySelectorAll('.alert');
    alerts.forEach((alert, index) => {
        alert.style.animationDelay = \`\${0.3 + index * 0.1}s\`;
    });
    
    console.log('âœ¨ Modal animations initialized');
});

// ðŸ“± Mobile Responsive Adjustments
function adjustModalForMobile() {
    const isMobile = window.innerWidth <= 768;
    const modal = document.getElementById('restoreModal');
    
    if (isMobile && modal) {
        const modalDialog = modal.querySelector('.modal-dialog');
        modalDialog.style.margin = '1rem';
        modalDialog.style.maxHeight = '90vh';
        modalDialog.style.overflowY = 'auto';
    }
}

window.addEventListener('resize', adjustModalForMobile);
adjustModalForMobile(); // Initial check

console.log('ðŸŽ‰ Beautiful restore modal enhancements loaded successfully!');
</script>
{% endblock %}
