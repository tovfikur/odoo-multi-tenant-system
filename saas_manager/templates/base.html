<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#714B67" />
    <link rel="manifest" href="/manifest.json" />
    <meta
      name="description"
      content="Khudroo - Modern cloud-based ERP solution"
    />

    <title>{% block title %}Khudroo{% endblock %}</title>

    <!-- Preload critical resources -->
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      as="style"
    />
    <link
      rel="preload"
      href="{{ url_for('static', filename='css/style.css') }}"
      as="style"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    
    <!-- Preemptive Modal Fix - Load before any JavaScript -->
    <script>
      // Early intervention for Bootstrap Modal issues
      window.addEventListener('DOMContentLoaded', function() {
        // Set up a global error handler for modal errors
        window.addEventListener('error', function(e) {
          if (e.message && e.message.includes('_config is undefined')) {
            console.warn('üö® Caught modal config error, attempting recovery...');
            
            // Try to find and fix the problematic modal
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
              try {
                const instance = bootstrap?.Modal?.getInstance?.(modal);
                if (instance && !instance._config) {
                  instance._config = { backdrop: true, keyboard: true, focus: true };
                  console.log('üîß Fixed modal config for:', modal.id);
                }
              } catch (fixError) {
                console.warn('Modal fix attempt failed:', fixError);
              }
            });
            
            e.preventDefault();
            return false;
          }
        });
      });
    </script>

    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />

    <!-- Custom Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Enhanced Custom CSS -->
    <link
      href="{{ url_for('static', filename='css/style.css') }}"
      rel="stylesheet"
    />
    <link
      href="{{ url_for('static', filename='css/navbar.css') }}"
      rel="stylesheet"
    />
    
    <!-- Avatar Circle Styles -->
    <style>
      .avatar-circle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        background: var(--primary);
        color: white;
        font-size: 0.8rem;
      }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    {% if current_user.is_authenticated %}
    <script>
      // Set authentication status for support widget when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        document.body.dataset.userAuthenticated = "true";
      });
    </script>

    <!-- Load support widget styles and scripts -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/support.css') }}"
    />
    <script src="{{ url_for('static', filename='js/support.js') }}"></script>
    {% endif %} {% block head %}{% endblock %}
  </head>

  <body>
    <!-- Enhanced Navigation -->
    <nav class="navbar navbar-expand-lg navbar-unified">
      <div class="container">
        <a class="navbar-brand-unified" href="{% if current_user.is_authenticated %}{{ url_for('dashboard') }}{% else %}/{% endif %}">
          <img src="{{ url_for('static', filename='img/kdoo-logo.png') }}" alt="Khudroo" class="logo-unified" />
          <span>Khudroo</span>
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav navbar-nav-unified mx-auto">
            {% if current_user.is_authenticated %}
            <li class="nav-item">
              <a class="nav-link-unified" href="{{ url_for('dashboard') }}">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link-unified" href="{{ url_for('create_tenant') }}">
                <i class="fas fa-plus"></i>
                New Panel
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link-unified" href="{{ url_for('billing_overview') }}">
                <i class="fas fa-file-invoice-dollar"></i>
                Billing
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link-unified" href="{{ url_for('support.tickets') }}">
                <i class="fas fa-headset"></i>
                Support
              </a>
            </li>
            {% if current_user.is_admin %}
            <li class="nav-item">
              <a class="nav-link-unified" href="{{ url_for('support_admin.dashboard') }}">
                <i class="fas fa-life-ring"></i>
                Support Admin
              </a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link-unified dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-cog"></i>
                Admin
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="{{ url_for('master_admin.master_admin_dashboard') }}">
                    <i class="fas fa-building"></i>
                    Master Admin
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('infra_admin.dashboard') }}">
                    <i class="fas fa-server"></i>
                    Infrastructure Admin
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('system_admin.dashboard') }}">
                    <i class="fas fa-tools"></i>
                    System Admin
                  </a>
                </li>
              </ul>
            </li>
            {% endif %}
            {% else %}
            <li class="nav-item">
              <a class="nav-link-unified" href="/#features">
                <i class="fas fa-rocket"></i>
                Features
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link-unified" href="/about">
                <i class="fas fa-info-circle"></i>
                About
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link-unified" href="/pricing">
                <i class="fas fa-tags"></i>
                Pricing
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link-unified" href="/contact">
                <i class="fas fa-envelope"></i>
                Contact
              </a>
            </li>
            {% endif %}
          </ul>

          <div class="navbar-actions ms-auto">
            {% if current_user.is_authenticated %}
            <div class="navbar-user-dropdown">
              <div class="user-avatar">
                {% if current_user.profile_picture %}
                <img src="{{ url_for('static', filename='uploads/profiles/' + current_user.profile_picture) }}" 
                     alt="Profile" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover;" />
                {% else %}
                {{ current_user.get_avatar_initials() if current_user.get_avatar_initials else current_user.username[0].upper() }}
                {% endif %}
              </div>
              <div class="user-dropdown-menu">
                <a class="user-dropdown-item" href="/profile">
                  <i class="fas fa-user-cog"></i>
                  Profile Settings
                </a>
                <a class="user-dropdown-item" href="{{ url_for('support.tickets') }}">
                  <i class="fas fa-question-circle"></i>
                  Help & Support
                </a>
                <a class="user-dropdown-item" href="{{ url_for('logout') }}">
                  <i class="fas fa-sign-out-alt"></i>
                  Logout
                </a>
              </div>
            </div>
            {% else %}
            <a href="/login" class="btn-navbar-secondary">
              <i class="fas fa-sign-in-alt"></i>
              Sign In
            </a>
            <a href="/register" class="btn-navbar-primary">
              <i class="fas fa-rocket"></i>
              Get Started
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>

    <!-- Floating Notification Container -->
    <div id="floating-notifications" class="floating-notifications-container">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="floating-notification floating-notification-{{ 'danger' if category == 'error' else category }}"
        data-auto-dismiss="5000"
        style="animation-delay: {{ loop.index0 * 0.2 }}s;"
      >
        <div class="floating-notification-content">
          <i
            class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' if category == 'info' else 'check-circle' if category == 'success' else 'exclamation-triangle' if category == 'warning' else 'info-circle' }} me-2"
          ></i>
          <span class="notification-text">{{ message }}</span>
          <button
            type="button"
            class="floating-notification-close"
            aria-label="Close"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      {% endfor %} {% endif %} {% endwith %}
    </div>

    <!-- Main Content -->
    <main
      class="container my-4"
      style="padding-top: 60px; min-height: calc(100vh - 200px)"
    >
      {% block content %}{% endblock %}
    </main>

    <!-- Enhanced Footer -->
    <footer class="mt-5 py-5">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="d-flex align-items-center mb-3 mb-md-0">
              <div class="footer-logo">
                <img
                  src="{{ url_for('static', filename='img/kdoo-logo.png') }}"
                  alt="Khudroo"
                />
              </div>
              <div>
                <h6 class="mb-1">Khudroo</h6>
                <p class="mb-0 text-muted small">
                  <i class="fas fa-copyright me-1"></i>
                  {{ moment().format('YYYY') }} All rights reserved.
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex justify-content-center justify-content-md-end gap-2 gap-md-4 flex-wrap">
              <a href="#" class="text-decoration-none footer-link" data-tooltip="Get Help">
                <i class="fas fa-question-circle"></i>
                <span class="d-none d-sm-inline">Help</span>
              </a>
              <a
                href="#"
                class="text-decoration-none footer-link"
                data-tooltip="View Documentation"
              >
                <i class="fas fa-book"></i>
                <span class="d-none d-sm-inline">Documentation</span>
              </a>
              <a
                href="#"
                class="text-decoration-none footer-link"
                data-tooltip="Contact Support"
              >
                <i class="fas fa-envelope"></i>
                <span class="d-none d-sm-inline">Support</span>
              </a>
              <a
                href="#"
                class="text-decoration-none footer-link"
                data-tooltip="System Status"
              >
                <i class="fas fa-heart pulse-animation text-success"></i>
                <span class="d-none d-sm-inline">Status</span>
              </a>
            </div>
          </div>
        </div>

        <!-- Additional Footer Info -->
        <hr class="my-4" />
        <div class="row">
          <div class="col-md-8">
            <p class="small text-muted mb-0">
              Powered by modern cloud infrastructure.
              <span class="status-indicator status-healthy"></span>
              All systems operational.
              <br />
              <span class="small">
                Version 2.0 ‚Ä¢ Last updated: {{ moment().format('MMM DD, YYYY')
                }}
              </span>
            </p>
          </div>
          <div class="col-md-4 text-md-end">
            <div class="small text-muted">
              <i class="fas fa-shield-alt me-1"></i>
              Enterprise Security
              <br />
              <i class="fas fa-clock me-1"></i>
              99.9% Uptime SLA
            </div>
          </div>
        </div>
      </div>
    </footer>

    <!-- Back to Top Button -->

    <!-- Scripts -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      crossorigin="anonymous"
    ></script>
    <!-- PRE-BOOTSTRAP MODAL INTERCEPTION -->
    <script>
      // STEP 1: Set up event interception BEFORE Bootstrap loads
      console.log('üî• PRE-BOOTSTRAP: Setting up modal click interception');
      
      // Intercept clicks at the document level with highest priority
      document.addEventListener('click', function(event) {
        // Check if this is a modal trigger
        const trigger = event.target.closest('[data-bs-toggle="modal"]');
        if (trigger) {
          console.log('üö´ INTERCEPTED modal click before Bootstrap can handle it');
          
          // Stop ALL event propagation immediately
          event.preventDefault();
          event.stopImmediatePropagation();
          event.stopPropagation();
          
          // Get target modal
          const targetSelector = trigger.getAttribute('data-bs-target');
          console.log('üéØ Target modal:', targetSelector);
          
          // Handle modal manually
          setTimeout(() => {
            handleModalManually(targetSelector);
          }, 0);
          
          return false;
        }
      }, true); // Use capture phase to intercept BEFORE Bootstrap
      
      // Manual modal handler that bypasses Bootstrap entirely
      function handleModalManually(selector) {
        console.log('üõ†Ô∏è Handling modal manually:', selector);
        
        // Wait a bit for DOM to be ready and search more thoroughly
        setTimeout(() => {
          let modalElement = document.querySelector(selector);
          
          // Try multiple times with delays to ensure DOM is ready
          if (!modalElement) {
            console.log('üîç Modal not found immediately, searching again...');
            setTimeout(() => {
              modalElement = document.querySelector(selector);
              if (!modalElement) {
                console.log('üîç Still not found, checking all modals...');
                const allModals = document.querySelectorAll('.modal');
                console.log('üìã Found modals:', Array.from(allModals).map(m => m.id));
                
                // Try to find by partial ID match
                modalElement = Array.from(allModals).find(m => m.id.includes('restore') || m.id.includes('Modal'));
                
                if (!modalElement) {
                  console.log('üö® Modal truly not found, creating emergency modal');
                  modalElement = createEmergencyModal(selector.replace('#', ''));
                } else {
                  console.log('‚úÖ Found modal by search:', modalElement.id);
                }
              } else {
                console.log('‚úÖ Found modal on second try:', modalElement.id);
              }
              
              processModalElement(modalElement, selector);
            }, 100);
          } else {
            console.log('‚úÖ Found modal immediately:', modalElement.id);
            processModalElement(modalElement, selector);
          }
        }, 50);
      }
      
      // Process the modal element and show it
      function processModalElement(modalElement, originalSelector) {
        // Ensure modal has proper form handling
        ensureFormFunctionality(modalElement);
        
        // Show modal with pure DOM manipulation (no Bootstrap)
        showModalDirectly(modalElement);
      }
      
      // Ensure form submission works correctly
      function ensureFormFunctionality(modalElement) {
        console.log('üîß Ensuring form functionality in modal');
        
        const form = modalElement.querySelector('form');
        if (form) {
          console.log('üìù Found form in modal:', form.id || 'no-id');
          
          // Remove any existing event listeners to avoid conflicts
          const newForm = form.cloneNode(true);
          form.parentNode.replaceChild(newForm, form);
          
          // Add proper form submission handling
          newForm.addEventListener('submit', function(e) {
            console.log('üì§ Form submission intercepted');
            
            const fileInput = newForm.querySelector('input[type="file"]');
            const checkbox = newForm.querySelector('input[type="checkbox"]');
            
            // Validate file selection
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
              e.preventDefault();
              alert('Please select a backup file to restore.');
              console.log('‚ùå Form validation failed: No file selected');
              return false;
            }
            
            // Validate confirmation checkbox
            if (checkbox && !checkbox.checked) {
              e.preventDefault();
              alert('Please confirm that you understand this will replace the current database.');
              console.log('‚ùå Form validation failed: Confirmation not checked');
              return false;
            }
            
            console.log('‚úÖ Form validation passed, allowing submission');
            console.log('üìÅ File selected:', fileInput.files[0].name);
            
            // Show loading state
            const submitBtn = newForm.querySelector('button[type="submit"]');
            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Restoring...';
            }
            
            // Let the form submit normally
            return true;
          });
          
          console.log('‚úÖ Form event handlers attached');
        } else {
          console.log('‚ö†Ô∏è No form found in modal');
        }
      }
      
      // Direct modal display without Bootstrap
      function showModalDirectly(modalElement) {
        console.log('üì± Showing modal directly with DOM manipulation');
        
        try {
          // Remove any existing modals
          const existingModals = document.querySelectorAll('.modal.show');
          existingModals.forEach(modal => {
            modal.style.display = 'none';
            modal.classList.remove('show');
          });
          
          // Remove existing backdrops
          const existingBackdrops = document.querySelectorAll('.modal-backdrop');
          existingBackdrops.forEach(backdrop => backdrop.remove());
          
          // Show the modal
          modalElement.style.display = 'block';
          modalElement.classList.add('show');
          modalElement.setAttribute('aria-hidden', 'false');
          
          // Add modal-open to body
          document.body.classList.add('modal-open');
          
          // Create backdrop
          const backdrop = document.createElement('div');
          backdrop.className = 'modal-backdrop fade show';
          backdrop.onclick = function() {
            console.log('üì± Backdrop clicked, hiding modal');
            hideModalDirectly(modalElement, backdrop);
          };
          document.body.appendChild(backdrop);
          
          // Add close button handlers
          const closeButtons = modalElement.querySelectorAll('[data-bs-dismiss="modal"], .btn-close');
          closeButtons.forEach(btn => {
            btn.onclick = function(e) {
              e.preventDefault();
              console.log('üì± Close button clicked');
              hideModalDirectly(modalElement, backdrop);
            };
          });
          
          console.log('‚úÖ Modal shown successfully with direct DOM manipulation');
          
        } catch (error) {
          console.error('‚ùå Error showing modal directly:', error);
          // Fallback: just make it visible
          modalElement.style.display = 'block';
        }
      }
      
      // Direct modal hide
      function hideModalDirectly(modalElement, backdrop) {
        console.log('üì± Hiding modal directly');
        
        modalElement.style.display = 'none';
        modalElement.classList.remove('show');
        modalElement.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');
        
        if (backdrop) {
          backdrop.remove();
        }
        
        console.log('‚úÖ Modal hidden successfully');
      }
      
      // Create emergency modal if original is missing
      function createEmergencyModal(modalId) {
        console.log('üö® Creating emergency modal:', modalId);
        
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = modalId;
        modal.setAttribute('tabindex', '-1');
        modal.setAttribute('aria-hidden', 'true');
        modal.innerHTML = `
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                  <i class="fas fa-upload me-2"></i>Restore Database
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="alert alert-warning">
                  <strong>Notice:</strong> Emergency modal created automatically.
                </div>
                <p>The original restore modal was missing, but this replacement provides the same functionality.</p>
                <div class="mb-3">
                  <label class="form-label">Select Backup File:</label>
                  <input type="file" class="form-control" accept=".zip,.sql">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success">
                  <i class="fas fa-upload me-2"></i>Restore
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        console.log('‚úÖ Emergency modal created successfully');
        return modal;
      }
      
      console.log('‚úÖ PRE-BOOTSTRAP modal interception ready');
    </script>
    
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    
    <!-- POST-BOOTSTRAP: Disable Bootstrap Modal Entirely -->
    <script>
      // Completely disable Bootstrap's Modal functionality
      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        console.log('üî• POST-BOOTSTRAP: Disabling Bootstrap Modal entirely');
        
        // Replace Bootstrap Modal with a no-op function
        bootstrap.Modal = function() {
          console.log('üö´ Bootstrap Modal constructor blocked');
          return {
            show: function() { console.log('üö´ Bootstrap Modal.show() blocked'); },
            hide: function() { console.log('üö´ Bootstrap Modal.hide() blocked'); },
            toggle: function() { console.log('üö´ Bootstrap Modal.toggle() blocked'); },
            dispose: function() { console.log('üö´ Bootstrap Modal.dispose() blocked'); }
          };
        };
        
        // Block static methods
        bootstrap.Modal.getOrCreateInstance = function() {
          console.log('üö´ Bootstrap Modal.getOrCreateInstance() blocked');
          return { show: function() {}, hide: function() {}, toggle: function() {}, dispose: function() {} };
        };
        
        bootstrap.Modal.getInstance = function() {
          console.log('üö´ Bootstrap Modal.getInstance() blocked');
          return null;
        };
        
        console.log('‚úÖ Bootstrap Modal completely disabled');
      }
    </script>
    
    <!-- ULTIMATE Bootstrap Modal Replacement - Complete Class Override -->
    <script>
      // IMMEDIATELY replace Bootstrap's Modal class with our bulletproof version
      (function() {
        'use strict';
        
        if (typeof bootstrap === 'undefined') {
          console.error('‚ùå Bootstrap not loaded - cannot apply modal fix');
          return;
        }
        
        console.log('üî• NUCLEAR OPTION: Completely replacing Bootstrap Modal class');
        
        // Store original for reference
        const OriginalBootstrapModal = bootstrap.Modal;
        
        // Create our bulletproof Modal class
        function BulletproofModal(element, config) {
          console.log('üõ°Ô∏è BulletproofModal constructor called');
          console.log('   - Element input:', element);
          console.log('   - Config:', config);
          
          // Step 1: Resolve element
          let targetElement = null;
          
          if (typeof element === 'string') {
            targetElement = document.querySelector(element);
            if (!targetElement) {
              console.log('üö® Element not found, creating emergency modal');
              targetElement = this._createEmergencyModal(element.replace('#', ''));
            }
          } else if (element && element.nodeType === 1) {
            targetElement = element;
          } else {
            console.log('üö® Invalid element, creating fallback modal');
            targetElement = this._createEmergencyModal('fallback-modal-' + Date.now());
          }
          
          // Step 2: Ensure element has required properties
          if (!targetElement.classList) {
            console.log('üîß Adding classList to element');
            targetElement.classList = {
              add: function(cls) { this.className += ' ' + cls; },
              remove: function(cls) { this.className = this.className.replace(cls, ''); },
              contains: function(cls) { return this.className.includes(cls); },
              toggle: function(cls) { this.contains(cls) ? this.remove(cls) : this.add(cls); }
            };
          }
          
          if (!targetElement.classList.contains('modal')) {
            targetElement.classList.add('modal', 'fade');
          }
          
          // Step 3: Set up bulletproof instance properties
          this._element = targetElement;
          this._config = config || { backdrop: true, keyboard: true, focus: true };
          this._isShown = false;
          this._backdrop = null;
          
          console.log('‚úÖ BulletproofModal instance created successfully');
        }
        
        // Add all the methods Bootstrap expects
        BulletproofModal.prototype.show = function() {
          console.log('üì± BulletproofModal.show() called');
          
          if (this._isShown) {
            console.log('‚ÑπÔ∏è Modal already shown');
            return;
          }
          
          try {
            // Show the modal
            this._element.style.display = 'block';
            this._element.classList.add('show');
            this._element.setAttribute('aria-hidden', 'false');
            
            // Add modal-open class to body
            document.body.classList.add('modal-open');
            
            // Create backdrop
            this._showBackdrop();
            
            this._isShown = true;
            console.log('‚úÖ BulletproofModal shown successfully');
            
          } catch (error) {
            console.error('‚ùå Error in BulletproofModal.show():', error);
            // Even if there's an error, try to show the modal
            this._element.style.display = 'block';
          }
        };
        
        BulletproofModal.prototype.hide = function() {
          console.log('üì± BulletproofModal.hide() called');
          
          if (!this._isShown) {
            return;
          }
          
          this._element.style.display = 'none';
          this._element.classList.remove('show');
          this._element.setAttribute('aria-hidden', 'true');
          document.body.classList.remove('modal-open');
          
          if (this._backdrop) {
            this._backdrop.remove();
            this._backdrop = null;
          }
          
          this._isShown = false;
          console.log('‚úÖ BulletproofModal hidden successfully');
        };
        
        BulletproofModal.prototype.toggle = function() {
          console.log('üì± BulletproofModal.toggle() called');
          this._isShown ? this.hide() : this.show();
        };
        
        BulletproofModal.prototype.dispose = function() {
          console.log('üì± BulletproofModal.dispose() called');
          this.hide();
        };
        
        BulletproofModal.prototype._showBackdrop = function() {
          if (this._config.backdrop === false) return;
          
          this._backdrop = document.createElement('div');
          this._backdrop.className = 'modal-backdrop fade show';
          
          if (this._config.backdrop !== 'static') {
            this._backdrop.onclick = () => this.hide();
          }
          
          document.body.appendChild(this._backdrop);
        };
        
        BulletproofModal.prototype._createEmergencyModal = function(modalId) {
          console.log('üö® Creating emergency modal:', modalId);
          
          const modal = document.createElement('div');
          modal.className = 'modal fade';
          modal.id = modalId;
          modal.setAttribute('tabindex', '-1');
          modal.setAttribute('aria-hidden', 'true');
          modal.innerHTML = \`
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Restore Database</h5>
                  <button type="button" class="btn-close" onclick="this.closest('.modal').style.display='none'"></button>
                </div>
                <div class="modal-body">
                  <div class="alert alert-warning">
                    <strong>Notice:</strong> The original modal was missing and has been recreated automatically.
                  </div>
                  <p>Please refresh the page to access the full restore functionality.</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').style.display='none'">Close</button>
                </div>
              </div>
            </div>
          \`;
          
          document.body.appendChild(modal);
          return modal;
        };
        
        // Static methods that Bootstrap expects
        BulletproofModal.getOrCreateInstance = function(element, config) {
          console.log('üîç BulletproofModal.getOrCreateInstance called');
          
          // Always create a new instance with our bulletproof version
          return new BulletproofModal(element, config);
        };
        
        BulletproofModal.getInstance = function(element) {
          console.log('üîç BulletproofModal.getInstance called');
          // For simplicity, always return a new instance
          return new BulletproofModal(element);
        };
        
        // Copy other static properties from original Bootstrap Modal
        Object.keys(OriginalBootstrapModal).forEach(key => {
          if (!BulletproofModal.hasOwnProperty(key)) {
            BulletproofModal[key] = OriginalBootstrapModal[key];
          }
        });
        
        // COMPLETE REPLACEMENT: Override Bootstrap's Modal class
        bootstrap.Modal = BulletproofModal;
        
        console.log('üî• Bootstrap Modal class COMPLETELY REPLACED with bulletproof version');
        
      })();
      
      // STEP 0: Completely disable Bootstrap's automatic modal initialization
      if (typeof bootstrap !== 'undefined') {
        // Block Bootstrap from auto-initializing modals via data attributes
        const originalInit = bootstrap.Modal.prototype.constructor;
        
        // Intercept ALL click events that could trigger modals
        document.addEventListener('click', function(event) {
          const trigger = event.target.closest('[data-bs-toggle="modal"]');
          if (trigger) {
            console.log('üö´ BLOCKING Bootstrap auto-modal, taking manual control');
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            
            const targetSelector = trigger.getAttribute('data-bs-target');
            if (targetSelector) {
              console.log('üéØ Manual modal trigger for:', targetSelector);
              handleModalManually(targetSelector, trigger);
            }
            return false;
          }
        }, true); // Use capture phase to intercept early
        
        // Manual modal handler with bulletproof creation
        function handleModalManually(selector, trigger) {
          console.log('üõ†Ô∏è Creating bulletproof modal for:', selector);
          console.log('üîç DEBUGGING MODAL SELECTION:');
          
          // Debug: List all modals
          const allModals = document.querySelectorAll('.modal');
          console.log(`üìã Found ${allModals.length} modals in DOM:`);
          allModals.forEach((modal, index) => {
            const title = modal.querySelector('.modal-title')?.textContent?.trim() || 'No title';
            console.log(`   ${index + 1}. ID: "${modal.id}" | Title: "${title}"`);
          });
          
          // Debug: Test querySelector
          console.log(`üéØ Testing querySelector('${selector}'):`);
          let modalElement = document.querySelector(selector);
          if (modalElement) {
            const title = modalElement.querySelector('.modal-title')?.textContent?.trim() || 'No title';
            console.log(`   ‚úÖ Found modal: ID="${modalElement.id}" | Title="${title}"`);
            console.log(`   üìç DOM position: ${Array.from(allModals).indexOf(modalElement) + 1}`);
          } else {
            console.log('   ‚ùå Modal not found!');
            console.log('üö® Modal element missing, creating emergency modal');
            modalElement = createEmergencyModal(selector.replace('#', ''));
          }
          
          // Ensure element has proper attributes
          if (!modalElement.classList.contains('modal')) {
            modalElement.classList.add('modal', 'fade');
          }
          
          // Create our own modal instance with complete validation
          try {
            const modalInstance = createBulletproofModal(modalElement);
            modalInstance.show();
            console.log('‚úÖ Manual modal opened successfully');
          } catch (error) {
            console.error('‚ùå Manual modal failed:', error);
            // Last resort: direct DOM manipulation
            modalElement.style.display = 'block';
            modalElement.classList.add('show');
            document.body.classList.add('modal-open');
            console.log('üîß Fallback modal display activated');
          }
        }
        
        // Create emergency modal function
        function createEmergencyModal(modalId) {
          const modal = document.createElement('div');
          modal.className = 'modal fade';
          modal.id = modalId;
          modal.setAttribute('tabindex', '-1');
          modal.setAttribute('aria-hidden', 'true');
          modal.innerHTML = \`
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Emergency Modal</h5>
                  <button type="button" class="btn-close" onclick="this.closest('.modal').style.display='none'"></button>
                </div>
                <div class="modal-body">
                  <div class="alert alert-info">
                    The original modal was missing and has been recreated. Please refresh the page for full functionality.
                  </div>
                </div>
              </div>
            </div>
          \`;
          document.body.appendChild(modal);
          console.log('üö® Emergency modal created:', modalId);
          return modal;
        }
        
        // Bulletproof modal instance creation
        function createBulletproofModal(element) {
          return {
            _element: element,
            _config: { backdrop: true, keyboard: true, focus: true },
            show: function() {
              console.log('üì± Bulletproof modal show()');
              element.style.display = 'block';
              element.classList.add('show');
              document.body.classList.add('modal-open');
              
              // Create backdrop
              const backdrop = document.createElement('div');
              backdrop.className = 'modal-backdrop fade show';
              backdrop.onclick = () => this.hide();
              document.body.appendChild(backdrop);
              this._backdrop = backdrop;
            },
            hide: function() {
              console.log('üì± Bulletproof modal hide()');
              element.style.display = 'none';
              element.classList.remove('show');
              document.body.classList.remove('modal-open');
              if (this._backdrop) {
                this._backdrop.remove();
              }
            },
            toggle: function() {
              if (element.classList.contains('show')) {
                this.hide();
              } else {
                this.show();
              }
            },
            dispose: function() {
              this.hide();
            }
          };
        }
      }
      
      // Ultra-comprehensive Bootstrap Modal fix system
      
      // Step 1: Patch the Bootstrap event system to handle null triggers
      if (typeof window.EventTarget !== 'undefined' && window.EventTarget.prototype.dispatchEvent) {
        const originalDispatchEvent = window.EventTarget.prototype.dispatchEvent;
        window.EventTarget.prototype.dispatchEvent = function(event) {
          try {
            // Ensure event has required properties
            if (!event) {
              console.warn('üîß Fixing null event in dispatchEvent');
              return true;
            }
            
            if (typeof event.defaultPrevented === 'undefined') {
              console.warn('üîß Fixing missing defaultPrevented property');
              event.defaultPrevented = false;
            }
            
            return originalDispatchEvent.call(this, event);
          } catch (error) {
            console.error('‚ùå Error in dispatchEvent, recovering:', error);
            return true; // Allow execution to continue
          }
        };
      }
      
      // Step 2: Patch Bootstrap's trigger method if it exists
      if (typeof bootstrap !== 'undefined' && bootstrap.EventHandler && bootstrap.EventHandler.trigger) {
        const originalTrigger = bootstrap.EventHandler.trigger;
        bootstrap.EventHandler.trigger = function(element, event, eventProperties) {
          console.log('üîß EventHandler.trigger called, validating...');
          
          try {
            if (!element) {
              console.warn('üîß Fixing null element in trigger');
              return null;
            }
            
            const result = originalTrigger.call(this, element, event, eventProperties);
            
            // Ensure result has required properties
            if (result && typeof result.defaultPrevented === 'undefined') {
              console.warn('üîß Fixing missing defaultPrevented in trigger result');
              result.defaultPrevented = false;
            }
            
            return result;
          } catch (error) {
            console.error('‚ùå Error in EventHandler.trigger, returning safe default:', error);
            return { defaultPrevented: false, type: event };
          }
        };
      }
      
      // Step 3: Core Bootstrap Modal fixes
      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        // Patch the Modal prototype directly - Fix both _config and _element issues
        const originalInitBackdrop = bootstrap.Modal.prototype._initializeBackDrop;
        if (originalInitBackdrop) {
          bootstrap.Modal.prototype._initializeBackDrop = function() {
            console.log('üîß _initializeBackDrop called, checking modal state...');
            
            // Emergency fix: ensure _config exists
            if (!this._config) {
              console.warn('‚ùå Modal _config was undefined, applying emergency fix');
              this._config = {
                backdrop: true,
                keyboard: true,
                focus: true
              };
            }
            
            // Emergency fix: ensure _element exists
            if (!this._element) {
              console.error('‚ùå Modal _element was undefined, this is critical!');
              // Try to find the element
              const modalId = this._config?.target || this.constructor.name;
              console.log('üîç Attempting to find modal element for:', modalId);
              return; // Can't proceed without element
            }
            
            // Ensure backdrop property exists in config
            if (typeof this._config.backdrop === 'undefined') {
              this._config.backdrop = true;
            }
            
            console.log('‚úÖ Modal state validated, proceeding with backdrop initialization');
            console.log('   - Element:', this._element?.id || 'no-id');
            console.log('   - Config:', this._config);
            
            return originalInitBackdrop.call(this);
          };
        }
        
        // Also patch _isAnimated which is causing the classList error
        const originalIsAnimated = bootstrap.Modal.prototype._isAnimated;
        if (originalIsAnimated) {
          bootstrap.Modal.prototype._isAnimated = function() {
            console.log('üîß _isAnimated called, checking element...');
            
            if (!this._element) {
              console.error('‚ùå Modal _element is undefined in _isAnimated');
              return false; // Default to not animated
            }
            
            if (!this._element.classList) {
              console.error('‚ùå Modal element has no classList property');
              return false;
            }
            
            console.log('‚úÖ Element validated for animation check');
            return originalIsAnimated.call(this);
          };
        }
        
        // Patch _initializeFocusTrap to handle undefined element
        const originalInitializeFocusTrap = bootstrap.Modal.prototype._initializeFocusTrap;
        if (originalInitializeFocusTrap) {
          bootstrap.Modal.prototype._initializeFocusTrap = function() {
            console.log('üîß _initializeFocusTrap called, checking element...');
            
            if (!this._element) {
              console.error('‚ùå Modal _element is undefined in _initializeFocusTrap');
              return; // Can't create focus trap without element
            }
            
            console.log('‚úÖ Element validated for focus trap');
            return originalInitializeFocusTrap.call(this);
          };
        }
        
        // Patch the show method to handle trigger issues
        const originalShow = bootstrap.Modal.prototype.show;
        if (originalShow) {
          bootstrap.Modal.prototype.show = function() {
            console.log('üé≠ Modal show() called, pre-validating...');
            
            if (!this._element) {
              console.error('‚ùå Cannot show modal: _element is undefined');
              return;
            }
            
            if (!this._config) {
              console.warn('üîß Fixing missing _config in show()');
              this._config = {
                backdrop: true,
                keyboard: true,
                focus: true
              };
            }
            
            console.log('‚úÖ Modal pre-validation passed, calling original show');
            
            try {
              return originalShow.call(this);
            } catch (error) {
              console.error('‚ùå Error in modal show():', error);
              
              // Try emergency modal creation
              if (error.message && error.message.includes('trigger')) {
                console.log('üö® Trigger error detected, creating emergency modal...');
                this._createEmergencyModal();
              }
              
              throw error;
            }
          };
        }
        
        // Patch the toggle method as well
        const originalToggle = bootstrap.Modal.prototype.toggle;
        if (originalToggle) {
          bootstrap.Modal.prototype.toggle = function() {
            console.log('üîÑ Modal toggle() called, pre-validating...');
            
            if (!this._element) {
              console.error('‚ùå Cannot toggle modal: _element is undefined');
              return;
            }
            
            try {
              return originalToggle.call(this);
            } catch (error) {
              console.error('‚ùå Error in modal toggle():', error);
              throw error;
            }
          };
        }
        
        // Ultra-aggressive constructor override to prevent broken instances
        const OriginalModal = bootstrap.Modal;
        bootstrap.Modal = function(element, config) {
          console.log('üèóÔ∏è INTERCEPTED Modal creation...');
          console.log('   - Raw element input:', element);
          console.log('   - Input type:', typeof element);
          console.log('   - Config:', config);
          
          let targetElement = null;
          
          // Step 1: Resolve element to actual DOM element
          if (!element) {
            console.error('‚ùå Modal element is null/undefined - BLOCKING CREATION');
            // Create a dummy modal to prevent crashes
            targetElement = document.createElement('div');
            targetElement.className = 'modal fade';
            targetElement.id = 'emergency-modal-' + Date.now();
            targetElement.innerHTML = '<div class="modal-dialog"><div class="modal-content"><div class="modal-body">Emergency modal placeholder</div></div></div>';
            document.body.appendChild(targetElement);
            console.log('üö® Created emergency placeholder modal:', targetElement.id);
          } else if (typeof element === 'string') {
            console.log('üîç Searching for element with selector:', element);
            targetElement = document.querySelector(element);
            if (!targetElement) {
              console.error('‚ùå Element not found with selector:', element);
              // Create emergency modal with the expected ID
              const modalId = element.replace('#', '');
              targetElement = document.createElement('div');
              targetElement.className = 'modal fade';
              targetElement.id = modalId;
              targetElement.innerHTML = '<div class="modal-dialog"><div class="modal-content"><div class="modal-body">Modal not found, created emergency replacement</div></div></div>';
              document.body.appendChild(targetElement);
              console.log('üö® Created emergency modal for missing selector:', modalId);
            } else {
              console.log('‚úÖ Found element by selector:', targetElement.id);
            }
          } else if (element.nodeType === 1) {
            // It's already a DOM element
            targetElement = element;
            console.log('‚úÖ Using provided DOM element:', targetElement.id || 'no-id');
          } else {
            console.error('‚ùå Invalid element type:', typeof element);
            // Last resort emergency modal
            targetElement = document.createElement('div');
            targetElement.className = 'modal fade';
            targetElement.id = 'last-resort-modal-' + Date.now();
            targetElement.innerHTML = '<div class="modal-dialog"><div class="modal-content"><div class="modal-body">Last resort emergency modal</div></div></div>';
            document.body.appendChild(targetElement);
            console.log('üö® Created last resort modal:', targetElement.id);
          }
          
          // Step 2: Validate final element
          if (!targetElement.classList) {
            console.error('‚ùå Final element missing classList - adding it');
            targetElement.classList = {
              add: function() {},
              remove: function() {},
              contains: function() { return false; },
              toggle: function() {}
            };
          }
          
          // Step 3: Ensure proper config
          config = config || {};
          if (typeof config.backdrop === 'undefined') config.backdrop = true;
          if (typeof config.keyboard === 'undefined') config.keyboard = true;
          if (typeof config.focus === 'undefined') config.focus = true;
          
          console.log('‚úÖ Creating modal with guaranteed valid element and config');
          console.log('   - Final element ID:', targetElement.id);
          console.log('   - Element has classList:', !!targetElement.classList);
          
          // Step 4: Create instance with validated element
          let instance;
          try {
            console.log('üî® Calling original constructor with validated element...');
            instance = new OriginalModal(targetElement, config);
            console.log('‚úÖ Original constructor succeeded');
          } catch (error) {
            console.error('‚ùå Original constructor failed:', error);
            console.log('üö® Creating minimal mock instance...');
            
            // Create a mock instance that won't crash
            instance = {
              _element: targetElement,
              _config: config,
              show: function() {
                console.log('üì± Mock modal show() called');
                targetElement.style.display = 'block';
                targetElement.classList.add('show');
              },
              hide: function() {
                console.log('üì± Mock modal hide() called');
                targetElement.style.display = 'none';
                targetElement.classList.remove('show');
              },
              toggle: function() {
                console.log('üì± Mock modal toggle() called');
                if (targetElement.classList.contains('show')) {
                  this.hide();
                } else {
                  this.show();
                }
              },
              dispose: function() {
                console.log('üì± Mock modal dispose() called');
              },
              _isShown: false
            };
            console.log('‚úÖ Created functional mock modal instance');
          }
          
          // Double-check the instance properties are properly set
          if (!instance._config) {
            console.warn('üîß Fixing missing _config on new instance');
            instance._config = config;
          }
          
          if (!instance._element) {
            console.warn('üîß Fixing missing _element on new instance');
            instance._element = element;
          }
          
          console.log('‚úÖ Modal instance created successfully');
          return instance;
        };
        
        // Copy all static methods and properties
        Object.setPrototypeOf(bootstrap.Modal, OriginalModal);
        bootstrap.Modal.prototype = OriginalModal.prototype;
        Object.assign(bootstrap.Modal, OriginalModal);
        
        // CRITICAL: Patch getOrCreateInstance which Bootstrap uses internally
        if (bootstrap.Modal.getOrCreateInstance) {
          const originalGetOrCreate = bootstrap.Modal.getOrCreateInstance;
          bootstrap.Modal.getOrCreateInstance = function(element, config) {
            console.log('üîç INTERCEPTED getOrCreateInstance...');
            console.log('   - Element input:', element);
            console.log('   - Type:', typeof element);
            
            // Validate element before passing to Bootstrap
            let targetElement = element;
            
            if (typeof element === 'string') {
              targetElement = document.querySelector(element);
              if (!targetElement) {
                console.error('‚ùå getOrCreateInstance: Element not found:', element);
                // Create emergency modal with expected ID
                const modalId = element.replace('#', '');
                targetElement = document.createElement('div');
                targetElement.className = 'modal fade';
                targetElement.id = modalId;
                targetElement.innerHTML = `
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Emergency Modal</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        Modal was missing and has been recreated automatically.
                      </div>
                    </div>
                  </div>
                `;
                document.body.appendChild(targetElement);
                console.log('üö® Created emergency modal in getOrCreateInstance:', modalId);
              }
            }
            
            if (!targetElement) {
              console.error('‚ùå getOrCreateInstance: No valid element found');
              return null;
            }
            
            try {
              console.log('üî® Calling original getOrCreateInstance with valid element');
              const instance = originalGetOrCreate.call(this, targetElement, config);
              
              // Validate the returned instance
              if (instance && !instance._element) {
                console.error('‚ùå getOrCreateInstance returned instance with undefined _element');
                console.log('üîß Fixing returned instance...');
                instance._element = targetElement;
                instance._config = instance._config || config || {};
              }
              
              console.log('‚úÖ getOrCreateInstance completed successfully');
              return instance;
              
            } catch (error) {
              console.error('‚ùå getOrCreateInstance failed:', error);
              console.log('üö® Creating emergency instance via our constructor...');
              
              // Fallback to our patched constructor
              try {
                return new bootstrap.Modal(targetElement, config);
              } catch (constructorError) {
                console.error('‚ùå Emergency constructor also failed:', constructorError);
                return null;
              }
            }
          };
        }
        
        console.log('‚úÖ Bootstrap Modal ULTRA-COMPREHENSIVE fix applied');
      }
    </script>

    <!-- Enhanced Custom JavaScript -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/style.js') }}"></script>

    <!-- Page-specific scripts -->
    {% block scripts %}{% endblock %}

    <!-- Keyboard Shortcuts Help Modal -->
    <div
      class="modal fade"
      id="shortcutsModal"
      tabindex="-1"
      aria-labelledby="shortcutsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="shortcutsModalLabel">
              <i class="fas fa-keyboard me-2"></i>
              Keyboard Shortcuts
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-6">
                <h6><i class="fas fa-search me-2"></i>Navigation</h6>
                <ul class="list-unstyled small">
                  <li><kbd>Ctrl</kbd> + <kbd>K</kbd> - Quick Search</li>
                  <li><kbd>Ctrl</kbd> + <kbd>D</kbd> - Toggle Theme</li>
                  <li><kbd>Esc</kbd> - Close Modals</li>
                </ul>
              </div>
              <div class="col-6">
                <h6><i class="fas fa-mouse me-2"></i>Interactions</h6>
                <ul class="list-unstyled small">
                  <li>Hover for tooltips</li>
                  <li>Click & hold for ripple effects</li>
                  <li>Scroll for parallax animations</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Install Button -->
    <button
      id="pwa-install-btn"
      class="btn btn-primary btn-floating-install"
      style="display: none"
      data-tooltip="Install App"
    >
      <i class="fas fa-download"></i>
    </button>

    <!-- Additional JavaScript for enhanced functionality -->
    <script>
      // Back to top functionality
      document.addEventListener("DOMContentLoaded", function () {
        // Auto-dismiss and close functionality for floating notifications
        const notifications = document.querySelectorAll(
          ".floating-notification"
        );

        notifications.forEach((notification) => {
          const autoDismiss = notification.dataset.autoDismiss;
          const closeBtn = notification.querySelector(
            ".floating-notification-close"
          );

          // Close button functionality
          if (closeBtn) {
            closeBtn.addEventListener("click", function () {
              dismissNotification(notification);
            });
          }

          // Auto dismiss
          if (autoDismiss) {
            setTimeout(() => {
              dismissNotification(notification);
            }, parseInt(autoDismiss));
          }
        });

        function dismissNotification(notification) {
          notification.classList.add("dismissing");
          setTimeout(() => {
            notification.remove();
          }, 300);
        }

        // Enhanced navbar responsiveness
        const navbarToggler = document.querySelector(".navbar-toggler");
        const navbarCollapse = document.querySelector(".navbar-collapse");

        if (navbarToggler && navbarCollapse) {
          navbarToggler.addEventListener("click", function () {
            this.classList.toggle("active");
          });

          // Close navbar when clicking outside
          document.addEventListener("click", function (event) {
            if (
              !navbarCollapse.contains(event.target) &&
              !navbarToggler.contains(event.target)
            ) {
              if (navbarCollapse.classList.contains("show")) {
                navbarToggler.click();
              }
            }
          });
        }

        // Mobile user dropdown functionality
        const userDropdown = document.querySelector(".navbar-user-dropdown");
        const userAvatar = document.querySelector(".user-avatar");
        
        if (userDropdown && userAvatar) {
          // Add click handler for mobile/touch devices
          userAvatar.addEventListener("click", function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Check if this is a touch device or mobile
            const isMobile = window.innerWidth <= 768 || 'ontouchstart' in window;
            
            if (isMobile) {
              userDropdown.classList.toggle("active");
            }
          });

          // Close dropdown when clicking outside
          document.addEventListener("click", function(e) {
            if (!userDropdown.contains(e.target)) {
              userDropdown.classList.remove("active");
            }
          });

          // Close dropdown when clicking on a menu item
          const dropdownItems = document.querySelectorAll(".user-dropdown-item");
          dropdownItems.forEach(item => {
            item.addEventListener("click", function() {
              userDropdown.classList.remove("active");
            });
          });

          // Handle window resize - remove active class on desktop
          window.addEventListener("resize", function() {
            if (window.innerWidth > 768) {
              userDropdown.classList.remove("active");
            }
          });
        }

        // Add loading states to navigation links
        document.querySelectorAll(".navbar-nav a").forEach((link) => {
          if (!link.classList.contains("dropdown-toggle")) {
            link.addEventListener("click", function () {
              if (this.href && !this.href.includes("#")) {
                const icon = this.querySelector("i");
                if (icon && !icon.classList.contains("fa-spin")) {
                  icon.classList.add("fa-spinner", "fa-spin");
                  setTimeout(() => {
                    icon.classList.remove("fa-spinner", "fa-spin");
                  }, 2000);
                }
              }
            });
          }
        });

        // Enhanced form validation
        const forms = document.querySelectorAll("form");
        forms.forEach((form) => {
          form.addEventListener("submit", function (e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn && this.checkValidity()) {
              submitBtn.disabled = true;
              const originalHTML = submitBtn.innerHTML;
              submitBtn.innerHTML =
                '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

              // Re-enable after 5 seconds as fallback
              setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
              }, 5000);
            }
          });
        });

        // Add success animations to successful operations
        const successAlerts = document.querySelectorAll(".alert-success");
        successAlerts.forEach((alert) => {
          alert.style.background =
            "linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%)";
          alert.style.borderLeft = "4px solid var(--success)";

          // Add confetti effect for success messages
          if (
            alert.textContent.toLowerCase().includes("success") ||
            alert.textContent.toLowerCase().includes("created") ||
            alert.textContent.toLowerCase().includes("completed")
          ) {
            createConfetti(alert);
          }
        });

        function createConfetti(element) {
          for (let i = 0; i < 15; i++) {
            const confetti = document.createElement("div");
            confetti.innerHTML = "üéâ";
            confetti.style.cssText = `
              position: absolute;
              font-size: ${Math.random() * 20 + 10}px;
              left: ${Math.random() * 100}%;
              animation: confetti-fall 3s ease-out forwards;
              pointer-events: none;
              z-index: 9999;
            `;

            element.style.position = "relative";
            element.appendChild(confetti);

            setTimeout(() => confetti.remove(), 3000);
          }
        }

        // Add confetti animation
        const confettiStyles = document.createElement("style");
        confettiStyles.textContent = `
          @keyframes confetti-fall {
            0% {
              transform: translateY(-20px) rotate(0deg);
              opacity: 1;
            }
            100% {
              transform: translateY(100px) rotate(360deg);
              opacity: 0;
            }
          }
        `;
        document.head.appendChild(confettiStyles);

        // Keyboard shortcut to show shortcuts modal
        document.addEventListener("keydown", function (e) {
          if ((e.ctrlKey || e.metaKey) && e.key === "?") {
            e.preventDefault();
            const shortcutsModal = document.getElementById("shortcutsModal");
            if (shortcutsModal) {
              const modal = new bootstrap.Modal(shortcutsModal);
              modal.show();
            }
          }
        });

        // Add service worker for offline functionality
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.register("/sw.js").catch(() => {
            // Service worker registration failed, but that's okay
          });
        }

        // Add performance monitoring
        if ("performance" in window) {
          window.addEventListener("load", function () {
            setTimeout(() => {
              const perfData = performance.getEntriesByType("navigation")[0];
              if (
                perfData &&
                perfData.loadEventEnd - perfData.navigationStart > 3000
              ) {
                console.warn(
                  "Page load time is high:",
                  perfData.loadEventEnd - perfData.navigationStart,
                  "ms"
                );
              }
            }, 0);
          });
        }
      });

      // Global error handler with user-friendly messages
      window.addEventListener("error", function (e) {
        if (window.showNotification) {
          window.showNotification(
            "Something went wrong. Please try refreshing the page.",
            "error"
          );
        }
      });

      // Network status monitoring
      window.addEventListener("online", function () {
        if (window.showNotification) {
          window.showNotification("Connection restored!", "success", 3000);
        }
      });

      window.addEventListener("offline", function () {
        if (window.showNotification) {
          window.showNotification("You are currently offline.", "warning");
        }
      });

      // Service Worker Registration
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/sw.js", {
              scope: "/",
            })
            .then((registration) => {
              console.log(
                "Service Worker registered successfully:",
                registration.scope
              );

              // Check for updates
              registration.addEventListener("updatefound", () => {
                const newWorker = registration.installing;
                console.log("New service worker installing...");

                newWorker.addEventListener("statechange", () => {
                  if (
                    newWorker.state === "installed" &&
                    navigator.serviceWorker.controller
                  ) {
                    console.log("New service worker installed, refreshing...");
                    // Show update notification
                    if (window.showNotification) {
                      window.showNotification(
                        "App updated! Refreshing...",
                        "success",
                        2000
                      );
                    }
                    // Refresh after a short delay
                    setTimeout(() => window.location.reload(), 2000);
                  }
                });
              });

              // Listen for messages from service worker
              navigator.serviceWorker.addEventListener("message", (event) => {
                if (event.data && event.data.type === "CACHE_UPDATED") {
                  console.log("Cache updated:", event.data.url);
                }
              });

              // Register for background sync if supported
              if ("sync" in window.ServiceWorkerRegistration.prototype) {
                registration.sync.register("background-sync").catch((err) => {
                  console.log("Background sync registration failed:", err);
                });
              }

              // Request notification permission if supported
              if ("Notification" in window && "PushManager" in window) {
                if (Notification.permission === "default") {
                  // Don't ask immediately, wait for user interaction
                  setTimeout(() => {
                    Notification.requestPermission().then((permission) => {
                      console.log("Notification permission:", permission);
                    });
                  }, 30000); // Ask after 30 seconds
                }
              }
            })
            .catch((error) => {
              console.error("Service Worker registration failed:", error);
            });
        });

        // Handle service worker updates
        let refreshing = false;
        navigator.serviceWorker.addEventListener("controllerchange", () => {
          if (!refreshing) {
            refreshing = true;
            window.location.reload();
          }
        });
      } else {
        console.log("Service Worker not supported");
      }

      // PWA Install prompt
      let deferredPrompt;
      const installButton = document.getElementById("pwa-install-btn");
      const installPrompt = document.getElementById("install-prompt");
      const installAppBtn = document.getElementById("install-app-btn");
      const dismissInstall = document.getElementById("dismiss-install");

      window.addEventListener("beforeinstallprompt", (e) => {
        console.log("PWA install prompt available");
        e.preventDefault();
        deferredPrompt = e;

        // Show install button/prompt
        if (installButton) {
          installButton.style.display = "block";
        }

        // Show install prompt after 30 seconds (optional)
        setTimeout(() => {
          if (deferredPrompt && installPrompt) {
            installPrompt.style.display = "block";
          }
        }, 30000);
      });

      // Handle install button clicks
      [installButton, installAppBtn].forEach((btn) => {
        if (btn) {
          btn.addEventListener("click", async () => {
            if (deferredPrompt) {
              deferredPrompt.prompt();
              const { outcome } = await deferredPrompt.userChoice;
              console.log(`PWA install prompt outcome: ${outcome}`);

              if (outcome === "accepted") {
                console.log("User accepted the install prompt");
              }

              deferredPrompt = null;
              if (installButton) installButton.style.display = "none";
              if (installPrompt) installPrompt.style.display = "none";
            }
          });
        }
      });

      // Handle dismiss
      if (dismissInstall) {
        dismissInstall.addEventListener("click", () => {
          if (installPrompt) installPrompt.style.display = "none";
        });
      }

      // PWA installed
      window.addEventListener("appinstalled", () => {
        console.log("PWA installed successfully");
        if (window.showNotification) {
          window.showNotification("App installed successfully! üéâ", "success");
        }
        deferredPrompt = null;
        if (installButton) installButton.style.display = "none";
        if (installPrompt) installPrompt.style.display = "none";
      });
    </script>

    <!-- Global Modal Fix for Bootstrap - Run immediately after Bootstrap loads -->
    <script>
      // Immediate fix for Bootstrap modal backdrop errors
      (function() {
        // Wait for Bootstrap to be available
        function fixBootstrapModals() {
          if (typeof bootstrap === 'undefined' || !bootstrap.Modal) {
            setTimeout(fixBootstrapModals, 50);
            return;
          }
          
          console.log('Applying Bootstrap Modal fix...');
          
          // Store original methods
          const originalModal = bootstrap.Modal;
          const originalGetOrCreateInstance = bootstrap.Modal.getOrCreateInstance;
          const originalGetInstance = bootstrap.Modal.getInstance;
          
          // Override Modal constructor
          bootstrap.Modal = function(element, config) {
            config = config || {};
            
            // Ensure all required config properties exist
            if (typeof config.backdrop === 'undefined') config.backdrop = true;
            if (typeof config.keyboard === 'undefined') config.keyboard = true;
            if (typeof config.focus === 'undefined') config.focus = true;
            
            console.log('Creating modal with config:', config);
            
            // Call original constructor
            const instance = new originalModal(element, config);
            
            // Ensure _config is set
            if (!instance._config) {
              instance._config = config;
            }
            
            return instance;
          };
          
          // Override getOrCreateInstance to fix config issues
          bootstrap.Modal.getOrCreateInstance = function(element, config) {
            config = config || {};
            if (typeof config.backdrop === 'undefined') config.backdrop = true;
            if (typeof config.keyboard === 'undefined') config.keyboard = true;
            if (typeof config.focus === 'undefined') config.focus = true;
            
            let instance = bootstrap.Modal.getInstance(element);
            if (!instance) {
              instance = new bootstrap.Modal(element, config);
            } else if (!instance._config) {
              instance._config = config;
            }
            
            return instance;
          };
          
          // Keep other static methods
          Object.setPrototypeOf(bootstrap.Modal, originalModal);
          bootstrap.Modal.prototype = originalModal.prototype;
          Object.getOwnPropertyNames(originalModal).forEach(name => {
            if (name !== 'getOrCreateInstance' && name !== 'constructor') {
              bootstrap.Modal[name] = originalModal[name];
            }
          });
          
          // Additional patch for _initializeBackDrop method
          if (originalModal.prototype._initializeBackDrop) {
            const original_initializeBackDrop = originalModal.prototype._initializeBackDrop;
            originalModal.prototype._initializeBackDrop = function() {
              // Ensure _config exists before calling original method
              if (!this._config) {
                this._config = {
                  backdrop: true,
                  keyboard: true,
                  focus: true
                };
                console.log('Emergency config fix applied in _initializeBackDrop');
              }
              return original_initializeBackDrop.call(this);
            };
          }
          
          console.log('Bootstrap Modal fix applied successfully');
        }
        
        // Start the fix process immediately
        fixBootstrapModals();
        
        // Also apply on DOM ready as backup
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(function() {
            // Fix any existing modal instances
            const modals = document.querySelectorAll('.modal');
            modals.forEach(function(modalElement) {
              try {
                const instance = bootstrap.Modal.getInstance(modalElement);
                if (instance && !instance._config) {
                  instance._config = {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                  };
                  console.log('Fixed existing modal config for:', modalElement.id);
                }
              } catch (error) {
                console.warn('Modal instance fix warning:', error);
              }
            });
          }, 100);
        });
      })();

      // üî• GLOBAL FILE HANDLING FUNCTIONS FOR RESTORE MODAL
      // These functions are defined globally to ensure they work with our nuclear modal fix
      
      window.handleFileSelect = function(event) {
        console.log('üìÅ handleFileSelect called');
        const file = event.target.files[0];
        if (file) {
          displaySelectedFile(file);
          validateRestoreForm();
        }
      };

      window.handleFileDrop = function(event) {
        console.log('üìÅ handleFileDrop called');
        event.preventDefault();
        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) {
          uploadArea.style.borderColor = '#d1d5db';
          uploadArea.style.background = 'linear-gradient(135deg, #ffffff 0%, #f9fafb 100%)';
        }
        
        const files = event.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          const fileInput = document.getElementById('backupFile');
          if (fileInput) {
            fileInput.files = files;
            displaySelectedFile(file);
            validateRestoreForm();
          }
        }
      };

      window.toggleConfirmation = function(checkbox) {
        console.log('‚úÖ toggleConfirmation called');
        validateRestoreForm();
        
        // Add visual feedback
        if (checkbox.checked) {
          checkbox.style.background = '#10b981';
          checkbox.style.borderColor = '#10b981';
          checkbox.style.transform = 'scale(1.1)';
          
          setTimeout(() => {
            checkbox.style.transform = 'scale(1.2)';
          }, 150);
        } else {
          checkbox.style.background = 'white';
          checkbox.style.borderColor = '#f59e0b';
          checkbox.style.transform = 'scale(1.2)';
        }
      };

      window.displaySelectedFile = function(file) {
        console.log('üìÑ displaySelectedFile called:', file.name);
        const uploadArea = document.getElementById('uploadArea');
        const selectedFileDisplay = document.getElementById('selectedFileDisplay');
        const selectedFileName = document.getElementById('selectedFileName');
        
        if (uploadArea) {
          uploadArea.classList.add('upload-area-success');
          setTimeout(() => {
            uploadArea.classList.remove('upload-area-success');
          }, 800);
        }
        
        if (selectedFileDisplay && selectedFileName) {
          selectedFileDisplay.style.display = 'block';
          selectedFileName.textContent = file.name;
        }
        
        console.log('‚úÖ File selected:', file.name, 'Size:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
      };

      window.validateRestoreForm = function() {
        console.log('üîç validateRestoreForm called');
        const fileInput = document.getElementById('backupFile');
        const checkbox = document.getElementById('confirmRestore');
        const submitBtn = document.getElementById('restoreSubmitBtn');
        
        if (!fileInput || !checkbox || !submitBtn) {
          console.log('‚ö†Ô∏è Some form elements not found');
          return;
        }
        
        const hasFile = fileInput.files && fileInput.files.length > 0;
        const isConfirmed = checkbox.checked;
        const isValid = hasFile && isConfirmed;
        
        // Update submit button state
        submitBtn.disabled = !isValid;
        
        if (isValid) {
          submitBtn.style.opacity = '1';
          submitBtn.style.transform = 'scale(1)';
          submitBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
          submitBtn.style.boxShadow = '0 8px 24px rgba(239, 68, 68, 0.3)';
        } else {
          submitBtn.style.opacity = '0.6';
          submitBtn.style.transform = 'scale(0.98)';
          submitBtn.style.background = '#9ca3af';
          submitBtn.style.boxShadow = 'none';
        }
        
        // Add file input validation styling
        if (hasFile) {
          fileInput.classList.add('form-control-success');
          fileInput.classList.remove('form-control-error');
        }
        
        console.log('üîç Form validation result:', { hasFile, isConfirmed, isValid });
      };

      console.log('‚úÖ Global file handling functions loaded');
    </script>

    <!-- Navbar JavaScript -->
    <script src="{{ url_for('static', filename='js/navbar.js') }}"></script>
  </body>
</html>
