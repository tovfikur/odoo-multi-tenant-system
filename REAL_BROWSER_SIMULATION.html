<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç REAL BROWSER SIMULATION - Exact Restore Button Test</title>
    
    <!-- EXACT CSS LOADING ORDER from manage_tenant.html -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { padding: 20px; background: #f8f9fa; font-family: 'Inter', sans-serif; }
        .simulation-card { background: white; padding: 20px; margin: 15px 0; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .console-output { background: #000; color: #00ff00; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 11px; height: 400px; overflow-y: auto; white-space: pre-wrap; }
        .status-light { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-red { background: #dc3545; }
        .status-green { background: #28a745; }
        .status-yellow { background: #ffc107; }
        
        /* Exact button styling from manage_tenant.html */
        .db-action-btn {
            border-radius: 12px !important;
            padding: 1rem !important;
            font-weight: 500 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">üîç REAL BROWSER SIMULATION</h1>
        <p class="lead">Testing the exact restore backup button behavior from the tenant management page</p>
        
        <div class="simulation-card">
            <h3>üìä Real-Time Test Status</h3>
            <div id="testStatus">
                <div><span id="js-load" class="status-light status-yellow"></span>JavaScript Loading: <span id="js-status">Initializing...</span></div>
                <div><span id="bootstrap-load" class="status-light status-yellow"></span>Bootstrap Status: <span id="bootstrap-status">Loading...</span></div>
                <div><span id="fix-load" class="status-light status-yellow"></span>Nuclear Fix Status: <span id="fix-status">Applying...</span></div>
                <div><span id="modal-load" class="status-light status-yellow"></span>Modal Status: <span id="modal-status">Checking...</span></div>
                <div><span id="click-test" class="status-light status-yellow"></span>Click Test: <span id="click-status">Ready to test</span></div>
            </div>
        </div>
        
        <div class="simulation-card">
            <h3>üéØ EXACT RESTORE BUTTON (copied from manage_tenant.html)</h3>
            <p>This is the <strong>exact same button</strong> from the tenant management page:</p>
            
            <!-- EXACT COPY of the restore button from manage_tenant.html line 512-517 -->
            <button class="btn btn-outline-success w-100 db-action-btn" 
                    data-bs-toggle="modal" 
                    data-bs-target="#restoreModal" 
                    style="border-radius: 12px; padding: 1rem; font-weight: 500;">
                <i class="fas fa-upload me-2"></i>Restore Backup
            </button>
            
            <div class="mt-3">
                <button class="btn btn-primary me-2" onclick="simulateRealClick()" title="Simulates a real browser click event">
                    üñ±Ô∏è Simulate Real Click
                </button>
                <button class="btn btn-warning me-2" onclick="testEmergencyModal()" title="Test what happens when modal is missing">
                    üö® Test Missing Modal
                </button>
                <button class="btn btn-info me-2" onclick="monitorBootstrap()" title="Monitor what Bootstrap tries to do">
                    üëÅÔ∏è Monitor Bootstrap
                </button>
            </div>
        </div>
        
        <div class="simulation-card">
            <h3>üì± Live Console Monitor</h3>
            <div id="liveConsole" class="console-output">üîç BROWSER SIMULATION STARTING...
Initializing exact environment from khudroo.com...

</div>
            <button class="btn btn-secondary btn-sm mt-2" onclick="clearConsole()">Clear Console</button>
        </div>
        
        <div class="simulation-card">
            <h3>üß™ Test Results</h3>
            <div id="testResults">
                <div class="alert alert-info">
                    <strong>Test Objective:</strong> Verify that clicking "Restore Backup" does NOT produce the error:
                    <code>Uncaught TypeError: can't access property "classList", this._element is undefined</code>
                </div>
            </div>
        </div>
    </div>

    <!-- EXACT MODAL HTML from manage_tenant.html lines 835-900 -->
    <div class="modal fade" id="restoreModal" tabindex="-1" aria-labelledby="restoreModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="border-radius: 16px; overflow: hidden;">
                <!-- Enhanced Header with Gradient -->
                <div class="modal-header border-0" style="background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%); padding: 2rem;">
                    <div class="d-flex align-items-center w-100">
                        <div class="p-3 rounded-circle me-3" style="background: rgba(255, 255, 255, 0.2);">
                            <i class="fas fa-upload text-white fa-lg"></i>
                        </div>
                        <div>
                            <h4 class="modal-title text-white fw-bold mb-1" id="restoreModalLabel">
                                Restore Database
                            </h4>
                            <p class="mb-0" style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem;">
                                Upload and restore from a backup file
                            </p>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <!-- Modal Body with Enhanced Design -->
                <div class="modal-body p-4">
                    <form method="POST" action="/tenant/8/restore" enctype="multipart/form-data" id="restoreForm">
                        <input type="hidden" name="csrf_token" value="test-token">
                        
                        <div class="alert alert-warning d-flex align-items-center mb-4">
                            <i class="fas fa-exclamation-triangle text-warning me-3 fa-lg"></i>
                            <div>
                                <strong>‚ö†Ô∏è SIMULATION MODE</strong><br>
                                This is a test simulation. No actual restore will be performed.
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="backupFile" class="form-label fw-bold">
                                <i class="fas fa-file-archive text-primary me-2"></i>Select Backup File
                            </label>
                            <input type="file" class="form-control form-control-lg" id="backupFile" name="backup_file" accept=".zip,.sql,.gz" required>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Supported formats: ZIP, SQL, GZ files
                            </div>
                        </div>
                        
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="confirmRestore" required>
                            <label class="form-check-label fw-bold text-danger" for="confirmRestore">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                I understand this will replace the current database
                            </label>
                        </div>
                    </form>
                </div>
                
                <!-- Modal Footer -->
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-danger btn-lg" form="restoreForm">
                        <i class="fas fa-upload me-2"></i>Restore Database
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- EXACT JAVASCRIPT LOADING ORDER from base.html -->
    
    <!-- jQuery (loaded first) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        function logToConsole(message, type = 'info') {
            const console_elem = document.getElementById('liveConsole');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            console_elem.innerHTML += `[${timestamp}] ${typeIcon} ${message}\n`;
            console_elem.scrollTop = console_elem.scrollHeight;
        }
        
        function updateStatus(elementId, status, message) {
            const light = document.getElementById(elementId);
            const statusText = document.getElementById(elementId.replace('-load', '-status').replace('-test', '-status'));
            
            light.className = `status-light status-${status === 'pass' ? 'green' : status === 'fail' ? 'red' : 'yellow'}`;
            statusText.textContent = message;
        }
        
        function clearConsole() {
            document.getElementById('liveConsole').innerHTML = 'üîç Console cleared...\n';
        }
        
        logToConsole('jQuery loaded successfully', 'success');
        updateStatus('js-load', 'pass', 'jQuery Ready');
    </script>
    
    <!-- OUR NUCLEAR FIX (Pre-Bootstrap) -->
    <script>
        logToConsole('üî• APPLYING NUCLEAR MODAL FIX (Pre-Bootstrap)...', 'warn');
        
        // STEP 1: Set up event interception BEFORE Bootstrap loads
        logToConsole('Setting up click interception with capture phase...');
        
        // Intercept clicks at the document level with highest priority
        document.addEventListener('click', function(event) {
            // Check if this is a modal trigger
            const trigger = event.target.closest('[data-bs-toggle="modal"]');
            if (trigger) {
                logToConsole('üö´ CLICK INTERCEPTED! Preventing Bootstrap from handling modal', 'warn');
                
                // Stop ALL event propagation immediately
                event.preventDefault();
                event.stopImmediatePropagation();
                event.stopPropagation();
                
                // Get target modal
                const targetSelector = trigger.getAttribute('data-bs-target');
                logToConsole(`üéØ Target modal: ${targetSelector}`);
                
                updateStatus('click-test', 'pass', 'Click Intercepted Successfully');
                
                // Handle modal manually
                setTimeout(() => {
                    handleModalManually(targetSelector);
                }, 10);
                
                return false;
            }
        }, true); // Use capture phase to intercept BEFORE Bootstrap
        
        // Manual modal handler that bypasses Bootstrap entirely
        function handleModalManually(selector) {
            logToConsole(`üõ†Ô∏è Handling modal manually: ${selector}`, 'success');
            
            let modalElement = document.querySelector(selector);
            
            if (!modalElement) {
                logToConsole('üö® Modal element not found, creating emergency modal', 'error');
                modalElement = createEmergencyModal(selector.replace('#', ''));
                updateStatus('modal-load', 'warn', 'Emergency Modal Created');
            } else {
                logToConsole('‚úÖ Modal element found in DOM', 'success');
                updateStatus('modal-load', 'pass', 'Modal Found');
            }
            
            // Show modal with pure DOM manipulation (no Bootstrap)
            showModalDirectly(modalElement);
        }
        
        // Direct modal display without Bootstrap
        function showModalDirectly(modalElement) {
            logToConsole('üì± Showing modal with direct DOM manipulation (no Bootstrap)', 'success');
            
            try {
                // Remove any existing modals
                const existingModals = document.querySelectorAll('.modal.show');
                existingModals.forEach(modal => {
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                });
                
                // Remove existing backdrops
                const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                existingBackdrops.forEach(backdrop => backdrop.remove());
                
                // Show the modal
                modalElement.style.display = 'block';
                modalElement.classList.add('show');
                modalElement.setAttribute('aria-hidden', 'false');
                
                // Add modal-open to body
                document.body.classList.add('modal-open');
                
                // Create backdrop
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                backdrop.onclick = function() {
                    logToConsole('üì± Backdrop clicked, hiding modal');
                    hideModalDirectly(modalElement, backdrop);
                };
                document.body.appendChild(backdrop);
                
                // Add close button handlers
                const closeButtons = modalElement.querySelectorAll('[data-bs-dismiss="modal"], .btn-close');
                closeButtons.forEach(btn => {
                    btn.onclick = function(e) {
                        e.preventDefault();
                        logToConsole('üì± Close button clicked');
                        hideModalDirectly(modalElement, backdrop);
                    };
                });
                
                logToConsole('‚úÖ Modal shown successfully with NO BOOTSTRAP INVOLVEMENT!', 'success');
                updateTestResult('PASS', 'Modal opened successfully without Bootstrap errors');
                
            } catch (error) {
                logToConsole(`‚ùå Error showing modal: ${error.message}`, 'error');
                updateTestResult('FAIL', `Error: ${error.message}`);
            }
        }
        
        // Direct modal hide
        function hideModalDirectly(modalElement, backdrop) {
            logToConsole('üì± Hiding modal directly');
            
            modalElement.style.display = 'none';
            modalElement.classList.remove('show');
            modalElement.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
            
            if (backdrop) {
                backdrop.remove();
            }
            
            logToConsole('‚úÖ Modal hidden successfully');
        }
        
        // Create emergency modal if original is missing
        function createEmergencyModal(modalId) {
            logToConsole(`üö® Creating emergency modal: ${modalId}`, 'warn');
            
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = modalId;
            modal.setAttribute('tabindex', '-1');
            modal.setAttribute('aria-hidden', 'true');
            modal.innerHTML = \`
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-upload me-2"></i>Emergency Restore Database
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <strong>Notice:</strong> Emergency modal created automatically.
                            </div>
                            <p>The original restore modal was missing, but this replacement provides the same functionality.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success">
                                <i class="fas fa-upload me-2"></i>Restore
                            </button>
                        </div>
                    </div>
                </div>
            \`;
            
            document.body.appendChild(modal);
            logToConsole('‚úÖ Emergency modal created successfully');
            return modal;
        }
        
        function updateTestResult(result, message) {
            const testResults = document.getElementById('testResults');
            const alertClass = result === 'PASS' ? 'alert-success' : 'alert-danger';
            const icon = result === 'PASS' ? '‚úÖ' : '‚ùå';
            
            testResults.innerHTML += \`
                <div class="alert \${alertClass} mt-2">
                    <strong>\${icon} \${result}:</strong> \${message}
                </div>
            \`;
        }
        
        logToConsole('‚úÖ Nuclear fix pre-Bootstrap setup complete');
        updateStatus('fix-load', 'pass', 'Pre-Bootstrap Fix Applied');
    </script>
    
    <!-- Bootstrap JS (loaded after our fix) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    
    <!-- Post-Bootstrap Modal Blocking -->
    <script>
        logToConsole('üî• APPLYING POST-BOOTSTRAP MODAL BLOCKING...', 'warn');
        
        // Completely disable Bootstrap's Modal functionality
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            logToConsole('Disabling Bootstrap Modal entirely...');
            
            // Store original for testing
            window.originalBootstrapModal = bootstrap.Modal;
            
            // Replace Bootstrap Modal with a no-op function
            bootstrap.Modal = function() {
                logToConsole('üö´ Bootstrap Modal constructor BLOCKED', 'warn');
                return {
                    show: function() { logToConsole('üö´ Bootstrap Modal.show() BLOCKED'); },
                    hide: function() { logToConsole('üö´ Bootstrap Modal.hide() BLOCKED'); },
                    toggle: function() { logToConsole('üö´ Bootstrap Modal.toggle() BLOCKED'); },
                    dispose: function() { logToConsole('üö´ Bootstrap Modal.dispose() BLOCKED'); }
                };
            };
            
            // Block static methods
            bootstrap.Modal.getOrCreateInstance = function() {
                logToConsole('üö´ Bootstrap Modal.getOrCreateInstance() BLOCKED');
                return { show: function() {}, hide: function() {}, toggle: function() {}, dispose: function() {} };
            };
            
            bootstrap.Modal.getInstance = function() {
                logToConsole('üö´ Bootstrap Modal.getInstance() BLOCKED');
                return null;
            };
            
            logToConsole('‚úÖ Bootstrap Modal completely disabled', 'success');
            updateStatus('bootstrap-load', 'pass', 'Bootstrap Modal Blocked');
        } else {
            logToConsole('‚ùå Bootstrap not found!', 'error');
            updateStatus('bootstrap-load', 'fail', 'Bootstrap Not Found');
        }
        
        logToConsole('‚úÖ Nuclear fix complete - Ready for testing!', 'success');
    </script>
    
    <!-- Test Functions -->
    <script>
        function simulateRealClick() {
            logToConsole('üñ±Ô∏è SIMULATING REAL BROWSER CLICK...', 'warn');
            
            const button = document.querySelector('[data-bs-toggle="modal"]');
            if (button) {
                logToConsole('Found restore button, creating click event...');
                
                // Create a real click event
                const clickEvent = new MouseEvent('click', {
                    bubbles: true,
                    cancelable: true,
                    view: window
                });
                
                logToConsole('Dispatching click event to button...');
                button.dispatchEvent(clickEvent);
                
                logToConsole('‚úÖ Click event dispatched successfully');
            } else {
                logToConsole('‚ùå Restore button not found!', 'error');
            }
        }
        
        function testEmergencyModal() {
            logToConsole('üö® TESTING EMERGENCY MODAL CREATION...', 'warn');
            
            const modal = document.getElementById('restoreModal');
            if (modal) {
                modal.remove();
                logToConsole('Removed original modal from DOM');
                updateStatus('modal-load', 'warn', 'Modal Removed for Test');
            }
            
            logToConsole('Now click the restore button to test emergency modal creation...');
        }
        
        function monitorBootstrap() {
            logToConsole('üëÅÔ∏è MONITORING BOOTSTRAP BEHAVIOR...', 'warn');
            
            // Try to create a Bootstrap modal instance
            try {
                const instance = new bootstrap.Modal('#restoreModal');
                logToConsole('‚ùå WARNING: Bootstrap Modal creation was NOT blocked!', 'error');
                updateTestResult('FAIL', 'Bootstrap Modal blocking failed');
            } catch (error) {
                logToConsole('‚úÖ Bootstrap Modal creation successfully blocked', 'success');
                updateTestResult('PASS', 'Bootstrap Modal blocking working');
            }
            
            // Try getOrCreateInstance
            try {
                const instance = bootstrap.Modal.getOrCreateInstance('#restoreModal');
                if (instance && typeof instance.show === 'function' && instance.show.toString().includes('BLOCKED')) {
                    logToConsole('‚úÖ getOrCreateInstance returning blocked instance', 'success');
                } else {
                    logToConsole('‚ùå getOrCreateInstance not properly blocked', 'error');
                }
            } catch (error) {
                logToConsole(`Bootstrap.Modal.getOrCreateInstance error: ${error.message}`);
            }
        }
        
        // Auto-run tests
        setTimeout(() => {
            logToConsole('üß™ RUNNING AUTOMATIC TESTS...');
            
            // Test 1: Check modal exists
            const modal = document.getElementById('restoreModal');
            if (modal) {
                logToConsole('‚úÖ Test 1 PASS: Modal element found in DOM', 'success');
                updateStatus('modal-load', 'pass', 'Modal Element Found');
            } else {
                logToConsole('‚ùå Test 1 FAIL: Modal element missing', 'error');
                updateStatus('modal-load', 'fail', 'Modal Element Missing');
            }
            
            // Test 2: Check Bootstrap blocking
            monitorBootstrap();
            
            logToConsole('üéØ ALL SYSTEMS READY! Click "Restore Backup" to test!', 'success');
            updateStatus('click-test', 'pass', 'Ready for Testing');
            
        }, 1000);
    </script>
</body>
</html>